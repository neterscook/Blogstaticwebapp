<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Folio ‚Äî Static Site Builder</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
<style>
/* ‚îÄ‚îÄ RESET & BASE ‚îÄ‚îÄ */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
:root {
  --bg: #f5f3ef;
  --panel: #ffffff;
  --panel2: #f0ede8;
  --border: #e0dbd2;
  --text: #1a1814;
  --muted: #8a8478;
  --accent: #1a1814;
  --accent-inv: #f5f3ef;
  --red: #d94f3d;
  --green: #2d7d52;
  --blue: #2563eb;
  --sidebar-w: 280px;
  --toolbar-h: 52px;
  --topbar-h: 56px;
}
body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); height:100vh; overflow:hidden; display:flex; flex-direction:column; font-size:14px; }

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
#topbar {
  height:var(--topbar-h); background:var(--panel); border-bottom:1px solid var(--border);
  display:flex; align-items:center; justify-content:space-between; padding:0 1rem; gap:1rem; flex-shrink:0; z-index:200;
}
.brand { font-family:'Syne',sans-serif; font-weight:800; font-size:1.1rem; letter-spacing:-0.02em; }
.brand span { opacity:0.35; }
.topbar-center { display:flex; align-items:center; gap:0.5rem; flex:1; justify-content:center; }
.page-tab {
  font-family:'Syne',sans-serif; font-size:0.75rem; font-weight:600; letter-spacing:0.04em;
  padding:0.35rem 0.85rem; border-radius:4px; border:1px solid transparent;
  cursor:pointer; background:none; color:var(--muted); transition:all 0.15s; white-space:nowrap;
}
.page-tab:hover { color:var(--text); background:var(--panel2); }
.page-tab.active { background:var(--accent); color:var(--accent-inv); border-color:var(--accent); }
.page-tab-add {
  width:28px; height:28px; border-radius:4px; border:1px dashed var(--border);
  background:none; cursor:pointer; color:var(--muted); font-size:1rem; display:flex; align-items:center; justify-content:center; transition:all 0.15s;
}
.page-tab-add:hover { border-color:var(--accent); color:var(--accent); }
.topbar-right { display:flex; align-items:center; gap:0.5rem; }
.btn-sm {
  font-family:'Syne',sans-serif; font-size:0.72rem; font-weight:700; letter-spacing:0.06em; text-transform:uppercase;
  padding:0.4rem 1rem; border-radius:4px; border:1px solid var(--border); background:none; cursor:pointer; color:var(--muted); transition:all 0.15s;
}
.btn-sm:hover { color:var(--text); border-color:var(--text); }
.btn-primary {
  background:var(--accent); color:var(--accent-inv); border-color:var(--accent);
}
.btn-primary:hover { background:#333; color:#fff; border-color:#333; }

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
#workspace { display:flex; flex:1; overflow:hidden; }

/* ‚îÄ‚îÄ LEFT SIDEBAR ‚îÄ‚îÄ */
#sidebar {
  width:var(--sidebar-w); background:var(--panel); border-right:1px solid var(--border);
  display:flex; flex-direction:column; overflow:hidden; flex-shrink:0;
}
.sidebar-tabs { display:flex; border-bottom:1px solid var(--border); }
.stab {
  flex:1; padding:0.6rem 0; font-family:'Syne',sans-serif; font-size:0.7rem; font-weight:700;
  letter-spacing:0.06em; text-transform:uppercase; text-align:center; cursor:pointer;
  border:none; background:none; color:var(--muted); border-bottom:2px solid transparent; transition:all 0.15s;
}
.stab.active { color:var(--text); border-bottom-color:var(--text); }
.sidebar-panel { flex:1; overflow-y:auto; padding:1rem; display:none; }
.sidebar-panel.active { display:block; }

/* ‚îÄ‚îÄ BLOCKS ‚îÄ‚îÄ */
.block-grid { display:grid; grid-template-columns:1fr 1fr; gap:0.5rem; }
.block-item {
  border:1px solid var(--border); border-radius:6px; padding:0.75rem 0.5rem; text-align:center;
  cursor:grab; background:var(--panel); transition:all 0.15s; user-select:none;
}
.block-item:hover { border-color:var(--accent); background:var(--panel2); }
.block-item:active { cursor:grabbing; }
.block-icon { font-size:1.3rem; margin-bottom:0.25rem; }
.block-label { font-size:0.68rem; font-weight:500; color:var(--muted); }

/* ‚îÄ‚îÄ THEME PANEL ‚îÄ‚îÄ */
.theme-section { margin-bottom:1.5rem; }
.theme-label { font-family:'Syne',sans-serif; font-size:0.68rem; font-weight:700; letter-spacing:0.08em; text-transform:uppercase; color:var(--muted); margin-bottom:0.6rem; display:block; }
.color-row { display:flex; gap:0.4rem; flex-wrap:wrap; margin-bottom:0.5rem; }
.color-swatch {
  width:28px; height:28px; border-radius:50%; cursor:pointer; border:2px solid transparent;
  transition:transform 0.15s; flex-shrink:0;
}
.color-swatch:hover { transform:scale(1.15); }
.color-swatch.active { border-color:var(--text); }
.color-custom { display:flex; align-items:center; gap:0.4rem; margin-top:0.4rem; }
.color-custom input[type=color] { width:28px; height:28px; border:1px solid var(--border); border-radius:4px; padding:1px; cursor:pointer; background:none; }
.color-custom label { font-size:0.75rem; color:var(--muted); }
.font-select, .range-input, .select-input {
  width:100%; padding:0.4rem 0.6rem; border:1px solid var(--border); border-radius:4px;
  background:var(--bg); font-family:'DM Sans',sans-serif; font-size:0.82rem; color:var(--text); outline:none; margin-bottom:0.5rem;
}
.font-select:focus, .range-input:focus, .select-input:focus { border-color:var(--accent); }
.range-row { display:flex; align-items:center; gap:0.5rem; }
.range-row input[type=range] { flex:1; accent-color:var(--accent); }
.range-val { font-size:0.75rem; color:var(--muted); min-width:32px; text-align:right; }

/* ‚îÄ‚îÄ PAGES PANEL ‚îÄ‚îÄ */
.page-item {
  display:flex; align-items:center; justify-content:space-between; padding:0.5rem 0.6rem;
  border-radius:4px; cursor:pointer; transition:background 0.15s; margin-bottom:0.25rem;
}
.page-item:hover { background:var(--panel2); }
.page-item.active { background:var(--panel2); font-weight:500; }
.page-item-name { font-size:0.85rem; flex:1; }
.page-del { background:none; border:none; color:var(--muted); cursor:pointer; font-size:0.9rem; padding:0.1rem 0.3rem; border-radius:3px; transition:color 0.15s; }
.page-del:hover { color:var(--red); }
.add-page-btn {
  width:100%; padding:0.5rem; border:1px dashed var(--border); border-radius:4px; background:none;
  color:var(--muted); font-size:0.8rem; cursor:pointer; transition:all 0.15s; margin-top:0.5rem;
}
.add-page-btn:hover { border-color:var(--accent); color:var(--accent); }

/* ‚îÄ‚îÄ TOOLBAR ‚îÄ‚îÄ */
#toolbar {
  height:var(--toolbar-h); background:var(--panel); border-bottom:1px solid var(--border);
  display:flex; align-items:center; padding:0 1rem; gap:0.25rem; flex-shrink:0; flex-wrap:wrap;
}
.tb-btn {
  height:32px; min-width:32px; padding:0 0.5rem; border-radius:4px; border:1px solid transparent;
  background:none; cursor:pointer; color:var(--text); font-size:0.85rem; display:flex; align-items:center; justify-content:center;
  transition:all 0.15s; font-family:'DM Sans',sans-serif; gap:0.3rem;
}
.tb-btn:hover { background:var(--panel2); border-color:var(--border); }
.tb-btn.active { background:var(--accent); color:var(--accent-inv); }
.tb-sep { width:1px; height:22px; background:var(--border); margin:0 0.25rem; flex-shrink:0; }
.tb-select {
  height:32px; padding:0 0.5rem; border:1px solid var(--border); border-radius:4px;
  background:var(--bg); font-family:'DM Sans',sans-serif; font-size:0.82rem; color:var(--text); outline:none; cursor:pointer;
}
.tb-select:focus { border-color:var(--accent); }
.tb-color { width:32px; height:32px; padding:3px; border:1px solid var(--border); border-radius:4px; cursor:pointer; background:var(--bg); }

/* ‚îÄ‚îÄ CANVAS AREA ‚îÄ‚îÄ */
#canvas-wrap {
  flex:1; overflow:auto; background:var(--bg); display:flex; align-items:flex-start; justify-content:center;
  padding:2rem;
}
#canvas-container { display:flex; flex-direction:column; height:100%; width:100%; }
#toolbar-wrap { flex-shrink:0; }

/* ‚îÄ‚îÄ PREVIEW FRAME ‚îÄ‚îÄ */
#preview-frame {
  width:100%; max-width:900px; margin:0 auto; background:#fff; border-radius:8px;
  box-shadow:0 4px 40px rgba(0,0,0,0.12); min-height:600px; overflow:hidden; position:relative;
}
#canvas {
  min-height:600px; outline:none; padding:2rem;
  font-family:var(--cf, 'Georgia, serif'); color:var(--cc, #1a1814);
  background:var(--cbg, #ffffff); line-height:1.7;
}
#canvas:empty::before { content:'Click blocks on the left to start building your page‚Ä¶'; color:#aaa; font-style:italic; }

/* Canvas element selection */
#canvas [data-block] { position:relative; cursor:default; outline:2px solid transparent; transition:outline 0.15s; margin-bottom:0.5rem; }
#canvas [data-block]:hover { outline:2px solid rgba(37,99,235,0.4); }
#canvas [data-block].selected { outline:2px solid var(--blue); }
#canvas [data-block] .block-controls {
  display:none; position:absolute; top:-1px; right:-1px; background:var(--blue); border-radius:0 4px 0 4px;
  gap:2px; padding:2px;
}
#canvas [data-block].selected .block-controls { display:flex; }
.bc-btn {
  width:22px; height:22px; border:none; background:none; cursor:pointer; color:#fff;
  font-size:0.75rem; border-radius:2px; display:flex; align-items:center; justify-content:center; transition:background 0.1s;
}
.bc-btn:hover { background:rgba(255,255,255,0.2); }

/* ‚îÄ‚îÄ CANVAS BLOCK STYLES ‚îÄ‚îÄ */
#canvas h1 { font-size:2.4em; font-weight:700; line-height:1.15; margin-bottom:0.5rem; }
#canvas h2 { font-size:1.8em; font-weight:600; line-height:1.2; margin-bottom:0.5rem; }
#canvas h3 { font-size:1.3em; font-weight:600; margin-bottom:0.4rem; }
#canvas p { margin-bottom:1rem; }
#canvas ul, #canvas ol { margin-left:1.5rem; margin-bottom:1rem; }
#canvas img { max-width:100%; border-radius:4px; display:block; }
#canvas hr { border:none; border-top:1px solid #e0dbd2; margin:1.5rem 0; }
#canvas blockquote { border-left:3px solid currentColor; padding-left:1rem; font-style:italic; margin:1rem 0; opacity:0.75; }
#canvas .hero-block { padding:3rem 2rem; text-align:center; }
#canvas .hero-block h1 { font-size:3em; margin-bottom:0.75rem; }
#canvas .hero-block p { font-size:1.15em; opacity:0.75; max-width:560px; margin:0 auto 1.5rem; }
#canvas .hero-btn { display:inline-block; padding:0.75rem 2rem; background:currentColor; border-radius:4px; font-weight:600; text-decoration:none; }
#canvas .cols-block { display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; }
#canvas .cols-block-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:1.5rem; }
#canvas .card-block { border:1px solid #e0dbd2; border-radius:8px; padding:1.5rem; }
#canvas .img-block img { width:100%; }
#canvas .divider-block hr { border-top-width:2px; }
#canvas .spacer-block { height:3rem; }
#canvas .nav-block { display:flex; align-items:center; justify-content:space-between; padding:1rem 0; border-bottom:1px solid #e0dbd2; margin-bottom:1rem; }
#canvas .nav-block .nav-logo { font-weight:700; font-size:1.1em; }
#canvas .nav-block .nav-links { display:flex; gap:1.5rem; font-size:0.9em; opacity:0.7; }
#canvas .footer-block { padding:2rem 0; border-top:1px solid #e0dbd2; margin-top:1rem; text-align:center; opacity:0.6; font-size:0.9em; }

/* ‚îÄ‚îÄ RIGHT PROPERTIES PANEL ‚îÄ‚îÄ */
#props-panel {
  width:240px; background:var(--panel); border-left:1px solid var(--border);
  display:flex; flex-direction:column; flex-shrink:0; overflow-y:auto;
}
.props-header { padding:0.75rem 1rem; border-bottom:1px solid var(--border); }
.props-title { font-family:'Syne',sans-serif; font-size:0.7rem; font-weight:700; letter-spacing:0.08em; text-transform:uppercase; color:var(--muted); }
.props-body { padding:1rem; }
.prop-row { margin-bottom:1rem; }
.prop-label { font-size:0.72rem; color:var(--muted); margin-bottom:0.3rem; display:block; font-weight:500; }
.prop-input {
  width:100%; padding:0.4rem 0.6rem; border:1px solid var(--border); border-radius:4px;
  background:var(--bg); font-family:'DM Sans',sans-serif; font-size:0.82rem; color:var(--text); outline:none;
}
.prop-input:focus { border-color:var(--accent); }
.prop-color { width:100%; height:34px; padding:2px; border:1px solid var(--border); border-radius:4px; cursor:pointer; background:none; }
.prop-empty { padding:2rem 1rem; text-align:center; color:var(--muted); font-size:0.82rem; font-style:italic; }

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.modal-overlay {
  display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1000;
  align-items:center; justify-content:center; backdrop-filter:blur(4px);
}
.modal-overlay.open { display:flex; animation:fadeIn 0.2s ease; }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
.modal {
  background:var(--panel); border-radius:8px; padding:1.5rem; width:90%; max-width:480px;
  box-shadow:0 20px 60px rgba(0,0,0,0.2);
}
.modal h3 { font-family:'Syne',sans-serif; font-size:1rem; font-weight:700; margin-bottom:1rem; }
.modal input, .modal textarea {
  width:100%; padding:0.5rem 0.75rem; border:1px solid var(--border); border-radius:4px;
  font-family:'DM Sans',sans-serif; font-size:0.9rem; color:var(--text); background:var(--bg); outline:none; margin-bottom:0.75rem;
}
.modal input:focus, .modal textarea:focus { border-color:var(--accent); }
.modal-btns { display:flex; gap:0.5rem; justify-content:flex-end; margin-top:0.5rem; }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
#toast {
  position:fixed; bottom:2rem; left:50%; transform:translateX(-50%) translateY(10px);
  background:var(--accent); color:var(--accent-inv); padding:0.6rem 1.5rem; border-radius:999px;
  font-size:0.82rem; font-weight:500; opacity:0; transition:all 0.3s; pointer-events:none; z-index:2000;
}
#toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

/* ‚îÄ‚îÄ DRAG DROP ‚îÄ‚îÄ */
.drop-indicator { height:3px; background:var(--blue); border-radius:2px; margin:2px 0; display:none; }
.drop-indicator.visible { display:block; }

/* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
::-webkit-scrollbar { width:5px; height:5px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:99px; }
</style>
</head>
<body>

<!-- TOPBAR -->
<div id="topbar">
  <div class="brand">Folio<span>.build</span></div>
  <div class="topbar-center" id="pageTabs"></div>
  <div class="topbar-right">
    <button class="btn-sm" id="openBtn">Open‚Ä¶</button>
    <button class="btn-sm" id="previewBtn">Preview</button>
    <button class="btn-sm btn-primary" id="exportBtn">Export HTML</button>
    <input type="file" id="openFileInput" accept=".html,text/html" style="display:none;">
  </div>
</div>

<!-- WORKSPACE -->
<div id="workspace">

  <!-- LEFT SIDEBAR -->
  <div id="sidebar">
    <div class="sidebar-tabs">
      <button class="stab active" data-tab="blocks">Blocks</button>
      <button class="stab" data-tab="theme">Theme</button>
      <button class="stab" data-tab="pages">Pages</button>
    </div>

    <!-- BLOCKS PANEL -->
    <div class="sidebar-panel active" id="tab-blocks">
      <div style="font-family:'Syne',sans-serif;font-size:0.68rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--muted);margin-bottom:0.6rem;">Layout</div>
      <div class="block-grid" id="blockPalette">
        <div class="block-item" data-block-type="hero" draggable="true"><div class="block-icon">ü¶∏</div><div class="block-label">Hero</div></div>
        <div class="block-item" data-block-type="nav" draggable="true"><div class="block-icon">üîó</div><div class="block-label">Nav Bar</div></div>
        <div class="block-item" data-block-type="heading" draggable="true"><div class="block-icon">H</div><div class="block-label">Heading</div></div>
        <div class="block-item" data-block-type="text" draggable="true"><div class="block-icon">¬∂</div><div class="block-label">Text</div></div>
        <div class="block-item" data-block-type="image" draggable="true"><div class="block-icon">üñº</div><div class="block-label">Image</div></div>
        <div class="block-item" data-block-type="cols2" draggable="true"><div class="block-icon">‚äü</div><div class="block-label">2 Columns</div></div>
        <div class="block-item" data-block-type="cols3" draggable="true"><div class="block-icon">‚äû</div><div class="block-label">3 Columns</div></div>
        <div class="block-item" data-block-type="card" draggable="true"><div class="block-icon">üÉè</div><div class="block-label">Card</div></div>
        <div class="block-item" data-block-type="quote" draggable="true"><div class="block-icon">"</div><div class="block-label">Quote</div></div>
        <div class="block-item" data-block-type="divider" draggable="true"><div class="block-icon">‚îÄ</div><div class="block-label">Divider</div></div>
        <div class="block-item" data-block-type="spacer" draggable="true"><div class="block-icon">‚Üï</div><div class="block-label">Spacer</div></div>
        <div class="block-item" data-block-type="footer" draggable="true"><div class="block-icon">ü¶∂</div><div class="block-label">Footer</div></div>
      </div>
    </div>

    <!-- THEME PANEL -->
    <div class="sidebar-panel" id="tab-theme">
      <div class="theme-section">
        <span class="theme-label">Background Color</span>
        <div class="color-row" id="bgSwatches">
          <div class="color-swatch active" style="background:#ffffff" data-color="#ffffff" data-target="bg" title="White"></div>
          <div class="color-swatch" style="background:#f5f3ef" data-color="#f5f3ef" data-target="bg" title="Cream"></div>
          <div class="color-swatch" style="background:#0d0d0e" data-color="#0d0d0e" data-target="bg" title="Black"></div>
          <div class="color-swatch" style="background:#1a2744" data-color="#1a2744" data-target="bg" title="Navy"></div>
          <div class="color-swatch" style="background:#1c2b1e" data-color="#1c2b1e" data-target="bg" title="Forest"></div>
          <div class="color-swatch" style="background:#2d1b3e" data-color="#2d1b3e" data-target="bg" title="Plum"></div>
        </div>
        <div class="color-custom">
          <input type="color" id="bgCustom" value="#ffffff">
          <label>Custom</label>
        </div>
      </div>

      <div class="theme-section">
        <span class="theme-label">Text Color</span>
        <div class="color-row" id="textSwatches">
          <div class="color-swatch active" style="background:#1a1814" data-color="#1a1814" data-target="text" title="Dark"></div>
          <div class="color-swatch" style="background:#f5f3ef" data-color="#f5f3ef" data-target="text" title="Light"></div>
          <div class="color-swatch" style="background:#2563eb" data-color="#2563eb" data-target="text" title="Blue"></div>
          <div class="color-swatch" style="background:#d94f3d" data-color="#d94f3d" data-target="text" title="Red"></div>
          <div class="color-swatch" style="background:#2d7d52" data-color="#2d7d52" data-target="text" title="Green"></div>
          <div class="color-swatch" style="background:#c9a96e" data-color="#c9a96e" data-target="text" title="Gold"></div>
        </div>
        <div class="color-custom">
          <input type="color" id="textCustom" value="#1a1814">
          <label>Custom</label>
        </div>
      </div>

      <div class="theme-section">
        <span class="theme-label">Font Family</span>
        <select class="font-select" id="fontSelect">
          <option value="Georgia, serif">Georgia (Serif)</option>
          <option value="'Playfair Display', Georgia, serif">Playfair Display</option>
          <option value="'DM Sans', system-ui, sans-serif">DM Sans</option>
          <option value="'Syne', system-ui, sans-serif">Syne</option>
          <option value="'Courier New', monospace">Courier New (Mono)</option>
          <option value="Garamond, 'Times New Roman', serif">Garamond</option>
          <option value="Helvetica, Arial, sans-serif">Helvetica</option>
          <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
        </select>
      </div>

      <div class="theme-section">
        <span class="theme-label">Content Width</span>
        <select class="select-input" id="widthSelect">
          <option value="680px">Narrow (680px)</option>
          <option value="860px" selected>Medium (860px)</option>
          <option value="1100px">Wide (1100px)</option>
          <option value="100%">Full Width</option>
        </select>
      </div>

      <div class="theme-section">
        <span class="theme-label">Font Size</span>
        <div class="range-row">
          <input type="range" id="fontSizeRange" min="12" max="22" value="16" step="1">
          <span class="range-val" id="fontSizeVal">16px</span>
        </div>
      </div>

      <div class="theme-section">
        <span class="theme-label">Line Height</span>
        <div class="range-row">
          <input type="range" id="lineHeightRange" min="1.2" max="2.2" value="1.7" step="0.1">
          <span class="range-val" id="lineHeightVal">1.7</span>
        </div>
      </div>

      <div class="theme-section">
        <span class="theme-label">Page Padding</span>
        <div class="range-row">
          <input type="range" id="paddingRange" min="0" max="80" value="32" step="4">
          <span class="range-val" id="paddingVal">32px</span>
        </div>
      </div>
    </div>

    <!-- PAGES PANEL -->
    <div class="sidebar-panel" id="tab-pages">
      <div id="pageList"></div>
      <button class="add-page-btn" id="addPageBtn">+ Add Page</button>
    </div>
  </div>

  <!-- MAIN EDITOR AREA -->
  <div style="flex:1;display:flex;flex-direction:column;overflow:hidden;">
    <div id="toolbar-wrap">
      <div id="toolbar">
        <select class="tb-select" id="blockFormatSelect">
          <option value="p">Paragraph</option>
          <option value="h1">Heading 1</option>
          <option value="h2">Heading 2</option>
          <option value="h3">Heading 3</option>
          <option value="h4">Heading 4</option>
          <option value="blockquote">Quote</option>
          <option value="pre">Code</option>
        </select>
        <div class="tb-sep"></div>
        <button class="tb-btn" id="tbBold" title="Bold"><b>B</b></button>
        <button class="tb-btn" id="tbItalic" title="Italic"><i>I</i></button>
        <button class="tb-btn" id="tbUnderline" title="Underline"><u>U</u></button>
        <button class="tb-btn" id="tbStrike" title="Strikethrough"><s>S</s></button>
        <div class="tb-sep"></div>
        <button class="tb-btn" id="tbUL" title="Bullet list">‚â°</button>
        <button class="tb-btn" id="tbOL" title="Numbered list">‚ãÆ</button>
        <div class="tb-sep"></div>
        <button class="tb-btn" id="tbAlignL" title="Align left">‚¨§‚óª‚óª</button>
        <button class="tb-btn" id="tbAlignC" title="Center">‚óª‚¨§‚óª</button>
        <button class="tb-btn" id="tbAlignR" title="Align right">‚óª‚óª‚¨§</button>
        <div class="tb-sep"></div>
        <button class="tb-btn" id="tbLink" title="Insert link">üîó</button>
        <button class="tb-btn" id="tbImg" title="Insert image">üñº</button>
        <div class="tb-sep"></div>
        <input type="color" class="tb-color" id="tbTextColor" title="Text color" value="#1a1814">
        <input type="color" class="tb-color" id="tbBgColor" title="Highlight color" value="#ffffff">
        <div class="tb-sep"></div>
        <button class="tb-btn" id="tbUndo" title="Undo">‚Ü©</button>
        <button class="tb-btn" id="tbRedo" title="Redo">‚Ü™</button>
      </div>
    </div>

    <div id="canvas-wrap">
      <div id="preview-frame">
        <div id="canvas" contenteditable="true" spellcheck="true"></div>
      </div>
    </div>
  </div>

  <!-- RIGHT PROPS PANEL -->
  <div id="props-panel">
    <div class="props-header"><div class="props-title">Properties</div></div>
    <div class="props-body" id="propsBody">
      <div class="prop-empty">Select a block to edit its properties.</div>
    </div>
  </div>

</div>

<!-- LINK MODAL -->
<div class="modal-overlay" id="linkModal">
  <div class="modal">
    <h3>Insert Link</h3>
    <input type="text" id="linkText" placeholder="Link text">
    <input type="url" id="linkUrl" placeholder="https://‚Ä¶">
    <div class="modal-btns">
      <button class="btn-sm" id="linkCancel">Cancel</button>
      <button class="btn-sm btn-primary" id="linkInsert">Insert</button>
    </div>
  </div>
</div>

<!-- IMAGE MODAL -->
<div class="modal-overlay" id="imgModal">
  <div class="modal">
    <h3>Insert Image</h3>
    <input type="url" id="imgUrl" placeholder="Image URL (https://‚Ä¶)">
    <div style="text-align:center;margin:0.5rem 0;color:var(--muted);font-size:0.8rem;">‚Äî or ‚Äî</div>
    <input type="file" id="imgFile" accept="image/*" style="margin-bottom:0.75rem;">
    <input type="text" id="imgAlt" placeholder="Alt text (optional)">
    <div class="modal-btns">
      <button class="btn-sm" id="imgCancel">Cancel</button>
      <button class="btn-sm btn-primary" id="imgInsert">Insert</button>
    </div>
  </div>
</div>

<!-- PAGE NAME MODAL -->
<div class="modal-overlay" id="pageModal">
  <div class="modal">
    <h3>New Page</h3>
    <input type="text" id="pageNameInput" placeholder="Page name (e.g. About)">
    <div class="modal-btns">
      <button class="btn-sm" id="pageCancel">Cancel</button>
      <button class="btn-sm btn-primary" id="pageCreate">Create</button>
    </div>
  </div>
</div>

<!-- PREVIEW MODAL -->
<div class="modal-overlay" id="previewModal" style="align-items:stretch;padding:1rem;">
  <div style="background:#fff;border-radius:8px;display:flex;flex-direction:column;width:100%;max-width:960px;margin:auto;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.25);">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:0.75rem 1rem;border-bottom:1px solid var(--border);background:var(--panel);">
      <span style="font-family:'Syne',sans-serif;font-size:0.75rem;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;color:var(--muted);">Preview</span>
      <button class="btn-sm" id="previewClose">Close</button>
    </div>
    <iframe id="previewIframe" style="flex:1;border:none;min-height:500px;"></iframe>
  </div>
</div>

<div id="toast"></div>

<script>
(function () {
'use strict';

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
var state = {
  pages: [{ id: 'home', name: 'Home', content: '' }],
  activePage: 'home',
  theme: {
    bg: '#ffffff',
    color: '#1a1814',
    font: 'Georgia, serif',
    fontSize: '16px',
    lineHeight: '1.7',
    padding: '32px',
    maxWidth: '860px'
  }
};

// ‚îÄ‚îÄ DOM REFS ‚îÄ‚îÄ
var canvas = document.getElementById('canvas');
var pageTabs = document.getElementById('pageTabs');
var pageList = document.getElementById('pageList');
var propsBody = document.getElementById('propsBody');
var blockFormatSelect = document.getElementById('blockFormatSelect');

// ‚îÄ‚îÄ BLOCK TEMPLATES ‚îÄ‚îÄ
var blockTemplates = {
  hero: function() {
    return '<div data-block="hero" class="hero-block" contenteditable="true">' +
      '<h1>Your Headline Here</h1>' +
      '<p>Write a compelling subtitle that explains what you do or offer.</p>' +
      '<a class="hero-btn" href="#">Get Started</a>' +
      '<div class="block-controls">' +
        '<button class="bc-btn" data-action="up" title="Move up">‚Üë</button>' +
        '<button class="bc-btn" data-action="down" title="Move down">‚Üì</button>' +
        '<button class="bc-btn" data-action="delete" title="Delete">‚úï</button>' +
      '</div></div>';
  },
  nav: function() {
    return '<div data-block="nav" class="nav-block" contenteditable="true">' +
      '<span class="nav-logo">Your Brand</span>' +
      '<div class="nav-links"><span>Home</span><span>About</span><span>Contact</span></div>' +
      '<div class="block-controls">' +
        '<button class="bc-btn" data-action="up">‚Üë</button>' +
        '<button class="bc-btn" data-action="down">‚Üì</button>' +
        '<button class="bc-btn" data-action="delete">‚úï</button>' +
      '</div></div>';
  },
  heading: function() {
    return '<div data-block="heading" contenteditable="true">' +
      '<h2>Section Heading</h2>' +
      '<div class="block-controls">' +
        '<button class="bc-btn" data-action="up">‚Üë</button>' +
        '<button class="bc-btn" data-action="down">‚Üì</button>' +
        '<button class="bc-btn" data-action="delete">‚úï</button>' +
      '</div></div>';
  },
  text: function() {
    return '<div data-block="text" contenteditable="true">' +
      '<p>Click here to start writing. You can edit this text directly and use the toolbar above to format it.</p>' +
      '<div class="block-controls">' +
        '<button class="bc-btn" data-action="up">‚Üë</button>' +
        '<button class="bc-btn" data-action="down">‚Üì</button>' +
        '<button class="bc-btn" data-action="delete">‚úï</button>' +
      '</div></div>';
  },
  image: function() {
    return '<div data-block="image" class="img-block">' +
      '<img src="https://images.unsplash.com/photo-1497366216548-37526070297c?w=860&q=80" alt="Image">' +
      '<div class="block-controls">' +
        '<button class="bc-btn" data-action="up">‚Üë</button>' +
        '<button class="bc-btn" data-action="down">‚Üì</button>' +
        '<button class="bc-btn" data-action="delete">‚úï</button>' +
      '</div></div>';
  },
  cols2: function() {
    return '<div data-block="cols2" class="cols-block">' +
      '<div contenteditable="true" style="min-height:60px;"><p>Left column content</p></div>' +
      '<div contenteditable="true" style="min-height:60px;"><p>Right column content</p></div>' +
      '<div class="block-controls">' +
        '<button class="bc-btn" data-action="up">‚Üë</button>' +
        '<button class="bc-btn" data-action="down">‚Üì</button>' +
        '<button class="bc-btn" data-action="delete">‚úï</button>' +
      '</div></div>';
  },
  cols3: function() {
    return '<div data-block="cols3" class="cols-block-3">' +
      '<div contenteditable="true" style="min-height:60px;"><p>Column one</p></div>' +
      '<div contenteditable="true" style="min-height:60px;"><p>Column two</p></div>' +
      '<div contenteditable="true" style="min-height:60px;"><p>Column three</p></div>' +
      '<div class="block-controls">' +
        '<button class="bc-btn" data-action="up">‚Üë</button>' +
        '<button class="bc-btn" data-action="down">‚Üì</button>' +
        '<button class="bc-btn" data-action="delete">‚úï</button>' +
      '</div></div>';
  },
  card: function() {
    return '<div data-block="card" class="card-block" contenteditable="true">' +
      '<h3>Card Title</h3><p>Card content goes here. Great for features, testimonials, or highlights.</p>' +
      '<div class="block-controls">' +
        '<button class="bc-btn" data-action="up">‚Üë</button>' +
        '<button class="bc-btn" data-action="down">‚Üì</button>' +
        '<button class="bc-btn" data-action="delete">‚úï</button>' +
      '</div></div>';
  },
  quote: function() {
    return '<div data-block="quote" contenteditable="true">' +
      '<blockquote>A memorable quote or highlighted insight goes here.</blockquote>' +
      '<div class="block-controls">' +
        '<button class="bc-btn" data-action="up">‚Üë</button>' +
        '<button class="bc-btn" data-action="down">‚Üì</button>' +
        '<button class="bc-btn" data-action="delete">‚úï</button>' +
      '</div></div>';
  },
  divider: function() {
    return '<div data-block="divider" class="divider-block"><hr>' +
      '<div class="block-controls">' +
        '<button class="bc-btn" data-action="up">‚Üë</button>' +
        '<button class="bc-btn" data-action="down">‚Üì</button>' +
        '<button class="bc-btn" data-action="delete">‚úï</button>' +
      '</div></div>';
  },
  spacer: function() {
    return '<div data-block="spacer" class="spacer-block">' +
      '<div class="block-controls">' +
        '<button class="bc-btn" data-action="up">‚Üë</button>' +
        '<button class="bc-btn" data-action="down">‚Üì</button>' +
        '<button class="bc-btn" data-action="delete">‚úï</button>' +
      '</div></div>';
  },
  footer: function() {
    return '<div data-block="footer" class="footer-block" contenteditable="true">' +
      '<p>¬© 2024 Your Brand. All rights reserved.</p>' +
      '<div class="block-controls">' +
        '<button class="bc-btn" data-action="up">‚Üë</button>' +
        '<button class="bc-btn" data-action="down">‚Üì</button>' +
        '<button class="bc-btn" data-action="delete">‚úï</button>' +
      '</div></div>';
  }
};

// ‚îÄ‚îÄ APPLY THEME ‚îÄ‚îÄ
function applyTheme() {
  var t = state.theme;
  canvas.style.setProperty('--cbg', t.bg);
  canvas.style.setProperty('--cc', t.color);
  canvas.style.setProperty('--cf', t.font);
  canvas.style.backgroundColor = t.bg;
  canvas.style.color = t.color;
  canvas.style.fontFamily = t.font;
  canvas.style.fontSize = t.fontSize;
  canvas.style.lineHeight = t.lineHeight;
  canvas.style.padding = t.padding;
  canvas.style.maxWidth = t.maxWidth;
  canvas.style.margin = '0 auto';
}

// ‚îÄ‚îÄ RENDER PAGES ‚îÄ‚îÄ
function renderPageTabs() {
  pageTabs.innerHTML = '';
  state.pages.forEach(function(page) {
    var btn = document.createElement('button');
    btn.className = 'page-tab' + (page.id === state.activePage ? ' active' : '');
    btn.textContent = page.name;
    btn.addEventListener('click', function() { switchPage(page.id); });
    pageTabs.appendChild(btn);
  });
  var add = document.createElement('button');
  add.className = 'page-tab-add';
  add.textContent = '+';
  add.title = 'Add page';
  add.addEventListener('click', function() { openModal('pageModal'); });
  pageTabs.appendChild(add);
}

function renderPageList() {
  pageList.innerHTML = '';
  state.pages.forEach(function(page) {
    var item = document.createElement('div');
    item.className = 'page-item' + (page.id === state.activePage ? ' active' : '');
    item.innerHTML = '<span class="page-item-name">' + page.name + '</span>';
    if (state.pages.length > 1) {
      var del = document.createElement('button');
      del.className = 'page-del';
      del.textContent = '‚úï';
      del.title = 'Delete page';
      del.addEventListener('click', function(e) { e.stopPropagation(); deletePage(page.id); });
      item.appendChild(del);
    }
    item.addEventListener('click', function() { switchPage(page.id); });
    pageList.appendChild(item);
  });
}

function switchPage(id) {
  saveCurrent();
  state.activePage = id;
  var page = state.pages.find(function(p) { return p.id === id; });
  canvas.innerHTML = page ? page.content : '';
  renderPageTabs();
  renderPageList();
  clearSelection();
}

function saveCurrent() {
  var page = state.pages.find(function(p) { return p.id === state.activePage; });
  if (page) page.content = canvas.innerHTML;
}

function deletePage(id) {
  if (state.pages.length <= 1) return;
  state.pages = state.pages.filter(function(p) { return p.id !== id; });
  if (state.activePage === id) state.activePage = state.pages[0].id;
  switchPage(state.activePage);
}

// ‚îÄ‚îÄ BLOCK INSERTION ‚îÄ‚îÄ
function insertBlock(type) {
  var tmpl = blockTemplates[type];
  if (!tmpl) return;
  var div = document.createElement('div');
  div.innerHTML = tmpl();
  var block = div.firstChild;
  canvas.appendChild(block);
  block.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  showToast('Block added');
}

// ‚îÄ‚îÄ BLOCK CONTROLS ‚îÄ‚îÄ
canvas.addEventListener('click', function(e) {
  var actionBtn = e.target.closest('[data-action]');
  if (actionBtn) {
    e.preventDefault(); e.stopPropagation();
    var block = actionBtn.closest('[data-block]');
    var action = actionBtn.getAttribute('data-action');
    if (action === 'delete') { block.remove(); clearSelection(); saveCurrent(); }
    else if (action === 'up' && block.previousElementSibling) { canvas.insertBefore(block, block.previousElementSibling); }
    else if (action === 'down' && block.nextElementSibling) { canvas.insertBefore(block.nextElementSibling, block); }
    return;
  }
  var block = e.target.closest('[data-block]');
  selectBlock(block);
});

var selectedBlock = null;
function selectBlock(block) {
  document.querySelectorAll('#canvas [data-block]').forEach(function(b) { b.classList.remove('selected'); });
  selectedBlock = block;
  if (block) {
    block.classList.add('selected');
    renderProps(block);
  } else {
    clearSelection();
  }
}

function clearSelection() {
  document.querySelectorAll('#canvas [data-block]').forEach(function(b) { b.classList.remove('selected'); });
  selectedBlock = null;
  propsBody.innerHTML = '<div class="prop-empty">Select a block to edit its properties.</div>';
}

// ‚îÄ‚îÄ PROPERTIES PANEL ‚îÄ‚îÄ
function renderProps(block) {
  var type = block.getAttribute('data-block');
  var html = '<div class="prop-row"><span class="prop-label">Block Type</span><input class="prop-input" value="' + type + '" readonly></div>';

  // Background color prop
  var bg = block.style.backgroundColor || '';
  html += '<div class="prop-row"><span class="prop-label">Background</span><input type="color" class="prop-color" id="propBg" value="' + (bg ? rgbToHex(bg) : '#ffffff') + '"></div>';

  // Padding prop
  var pad = block.style.padding || '';
  html += '<div class="prop-row"><span class="prop-label">Padding</span><input class="prop-input" id="propPad" value="' + pad + '" placeholder="e.g. 2rem"></div>';

  // Border radius
  var br = block.style.borderRadius || '';
  html += '<div class="prop-row"><span class="prop-label">Border Radius</span><input class="prop-input" id="propBr" value="' + br + '" placeholder="e.g. 8px"></div>';

  // Text align
  var ta = block.style.textAlign || 'left';
  html += '<div class="prop-row"><span class="prop-label">Text Align</span><select class="prop-input" id="propAlign"><option value="left">Left</option><option value="center">Center</option><option value="right">Right</option></select></div>';

  // Image src if image block
  if (type === 'image') {
    var img = block.querySelector('img');
    if (img) {
      html += '<div class="prop-row"><span class="prop-label">Image URL</span><input class="prop-input" id="propImgSrc" value="' + (img.src || '') + '"></div>';
      html += '<div class="prop-row"><span class="prop-label">Alt Text</span><input class="prop-input" id="propImgAlt" value="' + (img.alt || '') + '"></div>';
    }
  }

  propsBody.innerHTML = html;

  // Restore align select
  var alignSel = document.getElementById('propAlign');
  if (alignSel) { alignSel.value = ta; alignSel.addEventListener('change', function() { block.style.textAlign = this.value; }); }

  var bgInput = document.getElementById('propBg');
  if (bgInput) bgInput.addEventListener('input', function() { block.style.backgroundColor = this.value; });

  var padInput = document.getElementById('propPad');
  if (padInput) padInput.addEventListener('change', function() { block.style.padding = this.value; });

  var brInput = document.getElementById('propBr');
  if (brInput) brInput.addEventListener('change', function() { block.style.borderRadius = this.value; });

  var srcInput = document.getElementById('propImgSrc');
  if (srcInput) srcInput.addEventListener('change', function() { var img = block.querySelector('img'); if(img) img.src = this.value; });

  var altInput = document.getElementById('propImgAlt');
  if (altInput) altInput.addEventListener('change', function() { var img = block.querySelector('img'); if(img) img.alt = this.value; });
}

function rgbToHex(rgb) {
  var result = rgb.match(/\d+/g);
  if (!result) return '#ffffff';
  return '#' + result.slice(0,3).map(function(n) { return ('0' + parseInt(n).toString(16)).slice(-2); }).join('');
}

// ‚îÄ‚îÄ DRAG & DROP FROM PALETTE ‚îÄ‚îÄ
var dragType = null;

document.querySelectorAll('.block-item').forEach(function(item) {
  item.addEventListener('dragstart', function(e) {
    dragType = item.getAttribute('data-block-type');
    e.dataTransfer.effectAllowed = 'copy';
  });
  item.addEventListener('dragend', function() { dragType = null; });
});

canvas.addEventListener('dragover', function(e) {
  if (!dragType) return;
  e.preventDefault();
  e.dataTransfer.dropEffect = 'copy';
});

canvas.addEventListener('drop', function(e) {
  if (!dragType) return;
  e.preventDefault();
  insertBlock(dragType);
  dragType = null;
});

// ‚îÄ‚îÄ BLOCK PALETTE CLICK ‚îÄ‚îÄ
document.querySelectorAll('.block-item').forEach(function(item) {
  item.addEventListener('click', function() {
    insertBlock(item.getAttribute('data-block-type'));
  });
});

// ‚îÄ‚îÄ SIDEBAR TABS ‚îÄ‚îÄ
document.querySelectorAll('.stab').forEach(function(tab) {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.stab').forEach(function(t) { t.classList.remove('active'); });
    document.querySelectorAll('.sidebar-panel').forEach(function(p) { p.classList.remove('active'); });
    tab.classList.add('active');
    document.getElementById('tab-' + tab.getAttribute('data-tab')).classList.add('active');
  });
});

// ‚îÄ‚îÄ THEME CONTROLS ‚îÄ‚îÄ
function setupSwatches(selector, target) {
  document.querySelectorAll(selector).forEach(function(sw) {
    sw.addEventListener('click', function() {
      document.querySelectorAll(selector).forEach(function(s) { s.classList.remove('active'); });
      sw.classList.add('active');
      state.theme[target] = sw.getAttribute('data-color');
      applyTheme();
    });
  });
}
setupSwatches('[data-target="bg"]', 'bg');
setupSwatches('[data-target="text"]', 'color');

document.getElementById('bgCustom').addEventListener('input', function() {
  state.theme.bg = this.value;
  document.querySelectorAll('[data-target="bg"]').forEach(function(s) { s.classList.remove('active'); });
  applyTheme();
});

document.getElementById('textCustom').addEventListener('input', function() {
  state.theme.color = this.value;
  document.querySelectorAll('[data-target="text"]').forEach(function(s) { s.classList.remove('active'); });
  applyTheme();
});

document.getElementById('fontSelect').addEventListener('change', function() {
  state.theme.font = this.value;
  applyTheme();
});

document.getElementById('widthSelect').addEventListener('change', function() {
  state.theme.maxWidth = this.value;
  applyTheme();
});

function setupRange(rangeId, valId, themeKey, unit) {
  var range = document.getElementById(rangeId);
  var val = document.getElementById(valId);
  range.addEventListener('input', function() {
    var v = this.value + (unit || '');
    val.textContent = v;
    state.theme[themeKey] = v;
    applyTheme();
  });
}
setupRange('fontSizeRange', 'fontSizeVal', 'fontSize', 'px');
setupRange('lineHeightRange', 'lineHeightVal', 'lineHeight', '');
setupRange('paddingRange', 'paddingVal', 'padding', 'px');

// ‚îÄ‚îÄ TOOLBAR ACTIONS ‚îÄ‚îÄ
function tbCmd(cmd, val) {
  canvas.focus();
  document.execCommand(cmd, false, val || null);
}

document.getElementById('tbBold').addEventListener('click', function() { tbCmd('bold'); });
document.getElementById('tbItalic').addEventListener('click', function() { tbCmd('italic'); });
document.getElementById('tbUnderline').addEventListener('click', function() { tbCmd('underline'); });
document.getElementById('tbStrike').addEventListener('click', function() { tbCmd('strikeThrough'); });
document.getElementById('tbUL').addEventListener('click', function() { tbCmd('insertUnorderedList'); });
document.getElementById('tbOL').addEventListener('click', function() { tbCmd('insertOrderedList'); });
document.getElementById('tbAlignL').addEventListener('click', function() { tbCmd('justifyLeft'); });
document.getElementById('tbAlignC').addEventListener('click', function() { tbCmd('justifyCenter'); });
document.getElementById('tbAlignR').addEventListener('click', function() { tbCmd('justifyRight'); });
document.getElementById('tbUndo').addEventListener('click', function() { tbCmd('undo'); });
document.getElementById('tbRedo').addEventListener('click', function() { tbCmd('redo'); });

document.getElementById('tbTextColor').addEventListener('input', function() { tbCmd('foreColor', this.value); });
document.getElementById('tbBgColor').addEventListener('input', function() { tbCmd('hiliteColor', this.value); });

blockFormatSelect.addEventListener('change', function() {
  tbCmd('formatBlock', '<' + this.value + '>');
});

// ‚îÄ‚îÄ LINK MODAL ‚îÄ‚îÄ
var savedRange = null;
document.getElementById('tbLink').addEventListener('click', function() {
  var sel = window.getSelection();
  if (sel.rangeCount) savedRange = sel.getRangeAt(0).cloneRange();
  var selText = sel.toString();
  document.getElementById('linkText').value = selText;
  document.getElementById('linkUrl').value = '';
  openModal('linkModal');
});
document.getElementById('linkCancel').addEventListener('click', function() { closeModal('linkModal'); });
document.getElementById('linkInsert').addEventListener('click', function() {
  var url = document.getElementById('linkUrl').value.trim();
  var text = document.getElementById('linkText').value.trim();
  if (!url) return;
  canvas.focus();
  if (savedRange) {
    var sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(savedRange);
  }
  tbCmd('createLink', url);
  closeModal('linkModal');
  savedRange = null;
});

// ‚îÄ‚îÄ IMAGE MODAL ‚îÄ‚îÄ
document.getElementById('tbImg').addEventListener('click', function() { openModal('imgModal'); });
document.getElementById('imgCancel').addEventListener('click', function() { closeModal('imgModal'); });
document.getElementById('imgInsert').addEventListener('click', function() {
  var url = document.getElementById('imgUrl').value.trim();
  var alt = document.getElementById('imgAlt').value.trim();
  var file = document.getElementById('imgFile').files[0];

  function doInsert(src) {
    canvas.focus();
    var img = '<img src="' + src + '" alt="' + alt + '" style="max-width:100%;">';
    tbCmd('insertHTML', img);
    closeModal('imgModal');
    document.getElementById('imgUrl').value = '';
    document.getElementById('imgAlt').value = '';
    document.getElementById('imgFile').value = '';
  }

  if (file) {
    var reader = new FileReader();
    reader.onload = function(e) { doInsert(e.target.result); };
    reader.readAsDataURL(file);
  } else if (url) {
    doInsert(url);
  }
});

// ‚îÄ‚îÄ PAGE MODAL ‚îÄ‚îÄ
document.getElementById('addPageBtn').addEventListener('click', function() { openModal('pageModal'); });
document.getElementById('pageCancel').addEventListener('click', function() { closeModal('pageModal'); });
document.getElementById('pageCreate').addEventListener('click', function() {
  var name = document.getElementById('pageNameInput').value.trim();
  if (!name) return;
  var id = name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
  state.pages.push({ id: id, name: name, content: '' });
  closeModal('pageModal');
  document.getElementById('pageNameInput').value = '';
  switchPage(id);
  showToast('Page "' + name + '" created');
});

// ‚îÄ‚îÄ PREVIEW ‚îÄ‚îÄ
document.getElementById('previewBtn').addEventListener('click', function() {
  saveCurrent();
  var html = buildExport(true);
  var iframe = document.getElementById('previewIframe');
  iframe.srcdoc = html;
  openModal('previewModal');
});
document.getElementById('previewClose').addEventListener('click', function() { closeModal('previewModal'); });

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ
document.getElementById('exportBtn').addEventListener('click', function() {
  saveCurrent();
  var html = buildExport(false);
  var blob = new Blob([html], { type: 'text/html' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'site.html';
  a.click();
  URL.revokeObjectURL(url);
  showToast('Exported as site.html');
});

// ‚îÄ‚îÄ OPEN / IMPORT ‚îÄ‚îÄ
document.getElementById('openBtn').addEventListener('click', function() {
  document.getElementById('openFileInput').click();
});

document.getElementById('openFileInput').addEventListener('change', function() {
  var file = this.files[0];
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    importHTML(e.target.result, file.name);
  };
  reader.readAsText(file);
  this.value = ''; // reset so same file can be re-opened
});

function importHTML(html, filename) {
  // Parse the HTML string into a DOM
  var parser = new DOMParser();
  var doc = parser.parseFromString(html, 'text/html');

  // ‚îÄ‚îÄ Try to load embedded Folio metadata (clean round-trip) ‚îÄ‚îÄ
  var metaEl = doc.querySelector('meta[name="folio-data"]');
  if (metaEl) {
    try {
      var data = JSON.parse(metaEl.getAttribute('content'));

      // Restore theme
      if (data.theme) {
        state.theme = Object.assign(state.theme, data.theme);
        applyTheme();
        syncThemeUI();
      }

      // Restore pages ‚Äî re-inject block-controls since they were stripped on export
      if (data.pages && data.pages.length) {
        state.pages = data.pages.map(function(p) {
          return { id: p.id, name: p.name, content: rehydrateBlocks(p.content) };
        });
        state.activePage = state.pages[0].id;
        canvas.innerHTML = state.pages[0].content;
        renderPageTabs();
        renderPageList();
        applyTheme();
        clearSelection();
        showToast('Opened "' + (filename || 'file') + '" ‚Äî ' + state.pages.length + ' page(s) loaded');
      }
      return;
    } catch(err) {
      // Fall through to best-effort import
    }
  }

  // ‚îÄ‚îÄ Best-effort import for any HTML file ‚îÄ‚îÄ
  // Grab each .site-page section if multi-page, else grab body content
  var siteSections = doc.querySelectorAll('.site-page');
  var importedPages = [];

  if (siteSections.length > 0) {
    siteSections.forEach(function(section) {
      var id = section.id.replace('page-', '') || ('page' + Date.now());
      var name = id.charAt(0).toUpperCase() + id.slice(1).replace(/-/g, ' ');
      importedPages.push({ id: id, name: name, content: rehydrateBlocks(section.innerHTML) });
    });
  } else {
    // Single page ‚Äî take everything inside body, strip nav/script/style
    var body = doc.body;
    body.querySelectorAll('script, style, nav.site-nav').forEach(function(el) { el.remove(); });
    importedPages.push({ id: 'home', name: 'Home', content: rehydrateBlocks(body.innerHTML) });
  }

  // Try to recover theme from inline body styles
  var bodyStyle = doc.body.getAttribute('style') || '';
  var bgMatch = bodyStyle.match(/background:\s*([^;]+)/);
  var colorMatch = bodyStyle.match(/color:\s*([^;]+)/);
  if (bgMatch) state.theme.bg = bgMatch[1].trim();
  if (colorMatch) state.theme.color = colorMatch[1].trim();

  // Try to recover from CSS in <style> tags
  var styleText = Array.from(doc.querySelectorAll('style')).map(function(s) { return s.textContent; }).join('\n');
  var bodyBgMatch = styleText.match(/body\s*\{[^}]*background:\s*([^;}\n]+)/);
  var bodyColorMatch = styleText.match(/body\s*\{[^}]*color:\s*([^;}\n]+)/);
  var bodyFontMatch = styleText.match(/body\s*\{[^}]*font-family:\s*([^;}\n]+)/);
  if (bodyBgMatch) state.theme.bg = bodyBgMatch[1].trim();
  if (bodyColorMatch) state.theme.color = bodyColorMatch[1].trim();
  if (bodyFontMatch) state.theme.font = bodyFontMatch[1].trim();

  state.pages = importedPages;
  state.activePage = importedPages[0].id;
  canvas.innerHTML = importedPages[0].content;
  renderPageTabs();
  renderPageList();
  applyTheme();
  syncThemeUI();
  clearSelection();
  showToast('Imported "' + (filename || 'file') + '" ‚Äî ' + importedPages.length + ' page(s) loaded');
}

// Re-add block-controls markup to blocks that had them stripped on export
function rehydrateBlocks(html) {
  var div = document.createElement('div');
  div.innerHTML = html;
  var controls = '<div class="block-controls">' +
    '<button class="bc-btn" data-action="up">‚Üë</button>' +
    '<button class="bc-btn" data-action="down">‚Üì</button>' +
    '<button class="bc-btn" data-action="delete">‚úï</button>' +
    '</div>';
  div.querySelectorAll('[data-block]').forEach(function(block) {
    // Add contenteditable back to editable block types
    var type = block.getAttribute('data-block');
    var nonEditable = ['image', 'divider', 'spacer', 'cols2', 'cols3'];
    if (nonEditable.indexOf(type) === -1) {
      block.setAttribute('contenteditable', 'true');
    }
    // Re-add controls if missing
    if (!block.querySelector('.block-controls')) {
      block.insertAdjacentHTML('beforeend', controls);
    }
  });
  return div.innerHTML;
}

// Sync theme panel UI controls to match loaded state.theme
function syncThemeUI() {
  var t = state.theme;

  // Background swatches
  document.querySelectorAll('[data-target="bg"]').forEach(function(s) {
    s.classList.toggle('active', s.getAttribute('data-color') === t.bg);
  });
  var bgC = document.getElementById('bgCustom');
  if (bgC) { try { bgC.value = t.bg; } catch(e){} }

  // Text swatches
  document.querySelectorAll('[data-target="text"]').forEach(function(s) {
    s.classList.toggle('active', s.getAttribute('data-color') === t.color);
  });
  var txC = document.getElementById('textCustom');
  if (txC) { try { txC.value = t.color; } catch(e){} }

  // Font select
  var fs = document.getElementById('fontSelect');
  if (fs) fs.value = t.font;

  // Width
  var ws = document.getElementById('widthSelect');
  if (ws) ws.value = t.maxWidth;

  // Ranges
  var fsR = document.getElementById('fontSizeRange');
  var fsV = document.getElementById('fontSizeVal');
  if (fsR && t.fontSize) { fsR.value = parseInt(t.fontSize); if(fsV) fsV.textContent = t.fontSize; }

  var lhR = document.getElementById('lineHeightRange');
  var lhV = document.getElementById('lineHeightVal');
  if (lhR && t.lineHeight) { lhR.value = parseFloat(t.lineHeight); if(lhV) lhV.textContent = t.lineHeight; }

  var pR = document.getElementById('paddingRange');
  var pV = document.getElementById('paddingVal');
  if (pR && t.padding) { pR.value = parseInt(t.padding); if(pV) pV.textContent = t.padding; }
}
function buildExport(isPreview) {
  var t = state.theme;

  // Build nav links for multi-page
  var navLinks = state.pages.map(function(p, i) {
    return '<a href="' + (i === 0 ? '#' : '#page-' + p.id) + '" onclick="showPage(\'' + p.id + '\');return false;">' + p.name + '</a>';
  }).join('\n      ');

  // Build page sections from already-cleaned exportPages
  var sections = exportPages.map(function(p) {
    return '<section id="page-' + p.id + '" class="site-page">' + p.content + '</section>';
  }).join('\n');

  // Embed page content (with editor UI stripped) into metadata for round-trip import
  var exportPages = state.pages.map(function(p) {
    var div = document.createElement('div');
    div.innerHTML = p.content;
    div.querySelectorAll('.block-controls').forEach(function(bc) { bc.remove(); });
    div.querySelectorAll('[data-block]').forEach(function(b) { b.classList.remove('selected'); });
    return { id: p.id, name: p.name, content: div.innerHTML };
  });
  var folioMeta = JSON.stringify({ theme: state.theme, pages: exportPages });

  return '<!DOCTYPE html>\n<html lang="en">\n<head>\n' +
    '<meta charset="UTF-8">\n' +
    '<meta name="viewport" content="width=device-width, initial-scale=1.0">\n' +
    '<meta name="folio-data" content=\'' + folioMeta.replace(/'/g, '&#39;') + '\'>\n' +
    '<title>' + (state.pages[0] ? state.pages[0].name : 'My Site') + '</title>\n' +
    (t.font.includes('Playfair') ? '<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">\n' : '') +
    (t.font.includes('DM Sans') ? '<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">\n' : '') +
    (t.font.includes('Syne') ? '<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">\n' : '') +
    '<style>\n' +
    '*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }\n' +
    'body { font-family:' + t.font + '; background:' + t.bg + '; color:' + t.color + '; font-size:' + t.fontSize + '; line-height:' + t.lineHeight + '; }\n' +
    '.site-nav { display:flex; align-items:center; justify-content:space-between; padding:1rem 2rem; border-bottom:1px solid rgba(128,128,128,0.2); }\n' +
    '.site-nav a { color:inherit; text-decoration:none; font-weight:500; cursor:pointer; }\n' +
    '.site-nav .nav-links { display:flex; gap:2rem; }\n' +
    '.site-page { display:none; }\n' +
    '.site-page.active { display:block; }\n' +
    '.content-wrap { max-width:' + t.maxWidth + '; margin:0 auto; padding:' + t.padding + '; }\n' +
    'h1 { font-size:2.4em; font-weight:700; line-height:1.15; margin-bottom:0.5rem; }\n' +
    'h2 { font-size:1.8em; font-weight:600; line-height:1.2; margin-bottom:0.5rem; }\n' +
    'h3 { font-size:1.3em; font-weight:600; margin-bottom:0.4rem; }\n' +
    'p { margin-bottom:1rem; }\n' +
    'ul, ol { margin-left:1.5rem; margin-bottom:1rem; }\n' +
    'img { max-width:100%; border-radius:4px; display:block; }\n' +
    'hr { border:none; border-top:1px solid rgba(128,128,128,0.2); margin:1.5rem 0; }\n' +
    'blockquote { border-left:3px solid currentColor; padding-left:1rem; font-style:italic; margin:1rem 0; opacity:0.75; }\n' +
    'a { color:inherit; }\n' +
    '.hero-block { padding:4rem 2rem; text-align:center; }\n' +
    '.hero-block h1 { font-size:3em; margin-bottom:0.75rem; }\n' +
    '.hero-block p { font-size:1.15em; opacity:0.75; max-width:560px; margin:0 auto 1.5rem; }\n' +
    '.hero-btn { display:inline-block; padding:0.75rem 2rem; background:currentColor; border-radius:4px; font-weight:600; text-decoration:none; }\n' +
    '.cols-block { display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; }\n' +
    '.cols-block-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:1.5rem; }\n' +
    '.card-block { border:1px solid rgba(128,128,128,0.2); border-radius:8px; padding:1.5rem; }\n' +
    '.nav-block { display:flex; align-items:center; justify-content:space-between; padding:1rem 0; border-bottom:1px solid rgba(128,128,128,0.2); margin-bottom:1rem; }\n' +
    '.nav-block .nav-logo { font-weight:700; font-size:1.1em; }\n' +
    '.nav-block .nav-links { display:flex; gap:1.5rem; font-size:0.9em; opacity:0.7; }\n' +
    '.footer-block { padding:2rem 0; border-top:1px solid rgba(128,128,128,0.2); margin-top:1rem; text-align:center; opacity:0.6; font-size:0.9em; }\n' +
    '.spacer-block { height:3rem; }\n' +
    '@media (max-width:640px) { .cols-block, .cols-block-3 { grid-template-columns:1fr; } }\n' +
    '</style>\n</head>\n<body>\n' +
    (state.pages.length > 1 ? '<nav class="site-nav"><div class="nav-links">' + navLinks + '</div></nav>\n' : '') +
    '<div class="content-wrap">\n' + sections + '\n</div>\n' +
    '<script>\n' +
    '(function(){\n' +
    '  var pages = ' + JSON.stringify(state.pages.map(function(p) { return p.id; })) + ';\n' +
    '  function showPage(id) {\n' +
    '    document.querySelectorAll(".site-page").forEach(function(p){p.classList.remove("active");});\n' +
    '    var el = document.getElementById("page-"+id);\n' +
    '    if(el) el.classList.add("active");\n' +
    '    window.location.hash = id;\n' +
    '  }\n' +
    '  window.showPage = showPage;\n' +
    '  var hash = window.location.hash.replace("#","") || pages[0];\n' +
    '  showPage(hash);\n' +
    '})();\n' +
    '<\/script>\n</body>\n</html>';
}

// ‚îÄ‚îÄ MODAL HELPERS ‚îÄ‚îÄ
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(function(overlay) {
  overlay.addEventListener('click', function(e) { if (e.target === this) this.classList.remove('open'); });
});

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
var toastTimer;
function showToast(msg) {
  var toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(function() { toast.classList.remove('show'); }, 2200);
}

// ‚îÄ‚îÄ AUTOSAVE ‚îÄ‚îÄ
canvas.addEventListener('input', function() {
  clearTimeout(canvas._saveTimer);
  canvas._saveTimer = setTimeout(saveCurrent, 600);
});

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
applyTheme();
renderPageTabs();
renderPageList();
// Set first page active
if (state.pages.length > 0) {
  document.getElementById('page-' + state.activePage) || null;
}
showToast('Welcome to Folio ‚Äî click a block to begin');

})();
</script>
</body>
</html>.page-tab {
  font-family:'Syne',sans-serif; font-size:0.75rem; font-weight:600; letter-spacing:0.04em;
  padding:0.35rem 0.85rem; border-radius:4px; border:1px solid transparent;
  cursor:pointer; background:none; color:var(--muted); transition:all 0.15s; white-space:nowrap;
}
.page-tab:hover { color:var(--text); background:var(--panel2); }
.page-tab.active { background:var(--accent); color:var(--accent-inv); border-color:var(--accent); }
.page-tab-add {
  width:28px; height:28px; border-radius:4px; border:1px dashed var(--border);
  background:none; cursor:pointer; color:var(--muted); font-size:1rem; display:flex; align-items:center; justify-content:center; transition:all 0.15s;
}
.page-tab-add:hover { border-color:var(--accent); color:var(--accent); }
.topbar-right { display:flex; align-items:center; gap:0.5rem; }
.btn-sm {
  font-family:'Syne',sans-serif; font-size:0.72rem; font-weight:700; letter-spacing:0.06em; text-transform:uppercase;
  padding:0.4rem 1rem; border-radius:4px; border:1px solid var(--border); background:none; cursor:pointer; color:var(--muted); transition:all 0.15s;
}
.btn-sm:hover { color:var(--text); border-color:var(--text); }
.btn-primary {
  background:var(--accent); color:var(--accent-inv); border-color:var(--accent);
}
.btn-primary:hover { background:#333; color:#fff; border-color:#333; }

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
#workspace { display:flex; flex:1; overflow:hidden; }

/* ‚îÄ‚îÄ LEFT SIDEBAR ‚îÄ‚îÄ */
#sidebar {
  width:var(--sidebar-w); background:var(--panel); border-right:1px solid var(--border);
  display:flex; flex-direction:column; overflow:hidden; flex-shrink:0;
}
.sidebar-tabs { display:flex; border-bottom:1px solid var(--border); }
.stab {
  flex:1; padding:0.6rem 0; font-family:'Syne',sans-serif; font-size:0.7rem; font-weight:700;
  letter-spacing:0.06em; text-transform:uppercase; text-align:center; cursor:pointer;
  border:none; background:none; color:var(--muted); border-bottom:2px solid transparent; transition:all 0.15s;
}
.stab.active { color:var(--text); border-bottom-color:var(--text); }
.sidebar-panel { flex:1; overflow-y:auto; padding:1rem; display:none; }
.sidebar-panel.active { display:block; }

/* ‚îÄ‚îÄ BLOCKS ‚îÄ‚îÄ */
.block-grid { display:grid; grid-template-columns:1fr 1fr; gap:0.5rem; }
.block-item {
  border:1px solid var(--border); border-radius:6px; padding:0.75rem 0.5rem; text-align:center;
  cursor:grab; background:var(--panel); transition:all 0.15s; user-select:none;
}
.block-item:hover { border-color:var(--accent); background:var(--panel2); }
.block-item:active { cursor:grabbing; }
.block-icon { font-size:1.3rem; margin-bottom:0.25rem; }
.block-label { font-size:0.68rem; font-weight:500; color:var(--muted); }

/* ‚îÄ‚îÄ THEME PANEL ‚îÄ‚îÄ */
.theme-section { margin-bottom:1.5rem; }
.theme-label { font-family:'Syne',sans-serif; font-size:0.68rem; font-weight:700; letter-spacing:0.08em; text-transform:uppercase; color:var(--muted); margin-bottom:0.6rem; display:block; }
.color-row { display:flex; gap:0.4rem; flex-wrap:wrap; margin-bottom:0.5rem; }
.color-swatch {
  width:28px; height:28px; border-radius:50%; cursor:pointer; border:2px solid transparent;
  transition:transform 0.15s; flex-shrink:0;
}
.color-swatch:hover { transform:scale(1.15); }
.color-swatch.active { border-color:var(--text); }
.color-custom { display:flex; align-items:center; gap:0.4rem; margin-top:0.4rem; }
.color-custom input[type=color] { width:28px; height:28px; border:1px solid var(--border); border-radius:4px; padding:1px; cursor:pointer; background:none; }
.color-custom label { font-size:0.75rem; color:var(--muted); }
.font-select, .range-input, .select-input {
  width:100%; padding:0.4rem 0.6rem; border:1px solid var(--border); border-radius:4px;
  background:var(--bg); font-family:'DM Sans',sans-serif; font-size:0.82rem; color:var(--text); outline:none; margin-bottom:0.5rem;
}
.font-select:focus, .range-input:focus, .select-input:focus { border-color:var(--accent); }
.range-row { display:flex; align-items:center; gap:0.5rem; }
.range-row input[type=range] { flex:1; accent-color:var(--accent); }
.range-val { font-size:0.75rem; color:var(--muted); min-width:32px; text-align:right; }

/* ‚îÄ‚îÄ PAGES PANEL ‚îÄ‚îÄ */
.page-item {
  display:flex; align-items:center; justify-content:space-between; padding:0.5rem 0.6rem;
  border-radius:4px; cursor:pointer; transition:background 0.15s; margin-bottom:0.25rem;
}
.page-item:hover { background:var(--panel2); }
.page-item.active { background:var(--panel2); font-weight:500; }
.page-item-name { font-size:0.85rem; flex:1; }
.page-del { background:none; border:none; color:var(--muted); cursor:pointer; font-size:0.9rem; padding:0.1rem 0.3rem; border-radius:3px; transition:color 0.15s; }
.page-del:hover { color:var(--red); }
.add-page-btn {
  width:100%; padding:0.5rem; border:1px dashed var(--border); border-radius:4px; background:none;
  color:var(--muted); font-size:0.8rem; cursor:pointer; transition:all 0.15s; margin-top:0.5rem;
}
.add-page-btn:hover { border-color:var(--accent); color:var(--accent); }

/* ‚îÄ‚îÄ TOOLBAR ‚îÄ‚îÄ */
#toolbar {
  height:var(--toolbar-h); background:var(--panel); border-bottom:1px solid var(--border);
  display:flex; align-items:center; padding:0 1rem; gap:0.25rem; flex-shrink:0; flex-wrap:wrap;
}
.tb-btn {
  height:32px; min-width:32px; padding:0 0.5rem; border-radius:4px; border:1px solid transparent;
  background:none; cursor:pointer; color:var(--text); font-size:0.85rem; display:flex; align-items:center; justify-content:center;
  transition:all 0.15s; font-family:'DM Sans',sans-serif; gap:0.3rem;
}
.tb-btn:hover { background:var(--panel2); border-color:var(--border); }
.tb-btn.active { background:var(--accent); color:var(--accent-inv); }
.tb-sep { width:1px; height:22px; background:var(--border); margin:0 0.25rem; flex-shrink:0; }
.tb-select {
  height:32px; padding:0 0.5rem; border:1px solid var(--border); border-radius:4px;
  background:var(--bg); font-family:'DM Sans',sans-serif; font-size:0.82rem; color:var(--text); outline:none; cursor:pointer;
}
.tb-select:focus { border-color:var(--accent); }
.tb-color { width:32px; height:32px; padding:3px; border:1px solid var(--border); border-radius:4px; cursor:pointer; background:var(--bg); }

/* ‚îÄ‚îÄ CANVAS AREA ‚îÄ‚îÄ */
#canvas-wrap {
  flex:1; overflow:auto; background:var(--bg); display:flex; align-items:flex-start; justify-content:center;
  padding:2rem;
}
#canvas-container { display:flex; flex-direction:column; height:100%; width:100%; }
#toolbar-wrap { flex-shrink:0; }

/* ‚îÄ‚îÄ PREVIEW FRAME ‚îÄ‚îÄ */
#preview-frame {
  width:100%; max-width:900px; margin:0 auto; background:#fff; border-radius:8px;
  box-shadow:0 4px 40px rgba(0,0,0,0.12); min-height:600px; overflow:hidden; position:relative;
}
#canvas {
  min-height:600px; outline:none; padding:2rem;
  font-family:var(--cf, 'Georgia, serif'); color:var(--cc, #1a1814);
  background:var(--cbg, #ffffff); line-height:1.7;
}
#canvas:empty::before { content:'Click blocks on the left to start building your page‚Ä¶'; color:#aaa; font-style:italic; }

/* Canvas element selection */
#canvas [data-block] { position:relative; cursor:default; outline:2px solid transparent; transition:outline 0.15s; margin-bottom:0.5rem; }
#canvas [data-block]:hover { outline:2px solid rgba(37,99,235,0.4); }
#canvas [data-block].selected { outline:2px solid var(--blue); }
#canvas [data-block] .block-controls {
  display:none; position:absolute; top:-1px; right:-1px; background:var(--blue); border-radius:0 4px 0 4px;
  gap:2px; padding:2px;
}
#canvas [data-block].selected .block-controls { display:flex; }
.bc-btn {
  width:22px; height:22px; border:none; background:none; cursor:pointer; color:#fff;
  font-size:0.75rem; border-radius:2px; display:flex; align-items:center; justify-content:center; transition:background 0.1s;
}
.bc-btn:hover { background:rgba(255,255,255,0.2); }

/* ‚îÄ‚îÄ CANVAS BLOCK STYLES ‚îÄ‚îÄ */
#canvas h1 { font-size:2.4em; font-weight:700; line-height:1.15; margin-bottom:0.5rem; }
#canvas h2 { font-size:1.8em; font-weight:600; line-height:1.2; margin-bottom:0.5rem; }
#canvas h3 { font-size:1.3em; font-weight:600; margin-bottom:0.4rem; }
#canvas p { margin-bottom:1rem; }
#canvas ul, #canvas ol { margin-left:1.5rem; margin-bottom:1rem; }
#canvas img { max-width:100%; border-radius:4px; display:block; }
#canvas hr { border:none; border-top:1px solid #e0dbd2; margin:1.5rem 0; }
#canvas blockquote { border-left:3px solid currentColor; padding-left:1rem; font-style:italic; margin:1rem 0; opacity:0.75; }
#canvas .hero-block { padding:3rem 2rem; text-align:center; }
#canvas .hero-block h1 { font-size:3em; margin-bottom:0.75rem; }
#canvas .hero-block p { font-size:1.15em; opacity:0.75; max-width:560px; margin:0 auto 1.5rem; }
#canvas .hero-btn { display:inline-block; padding:0.75rem 2rem; background:currentColor; border-radius:4px; font-weight:600; text-decoration:none; }
#canvas .cols-block { display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; }
#canvas .cols-block-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:1.5rem; }
#canvas .card-block { border:1px solid #e0dbd2; border-radius:8px; padding:1.5rem; }
#canvas .img-block img { width:100%; }
#canvas .divider-block hr { border-top-width:2px; }
#canvas .spacer-block { height:3rem; }
#canvas .nav-block { display:flex; align-items:center; justify-content:space-between; padding:1rem 0; border-bottom:1px solid #e0dbd2; margin-bottom:1rem; }
#canvas .nav-block .nav-logo { font-weight:700; font-size:1.1em; }
#canvas .nav-block .nav-links { display:flex; gap:1.5rem; font-size:0.9em; opacity:0.7; }
#canvas .footer-block { padding:2rem 0; border-top:1px solid #e0dbd2; margin-top:1rem; text-align:center; opacity:0.6; font-size:0.9em; }

/* ‚îÄ‚îÄ RIGHT PROPERTIES PANEL ‚îÄ‚îÄ */
#props-panel {
  width:240px; background:var(--panel); border-left:1px solid var(--border);
  display:flex; flex-direction:column; flex-shrink:0; overflow-y:auto;
}
.props-header { padding:0.75rem 1rem; border-bottom:1px solid var(--border); }
.props-title { font-family:'Syne',sans-serif; font-size:0.7rem; font-weight:700; letter-spacing:0.08em; text-transform:uppercase; color:var(--muted); }
.props-body { padding:1rem; }
.prop-row { margin-bottom:1rem; }
.prop-label { font-size:0.72rem; color:var(--muted); margin-bottom:0.3rem; display:block; font-weight:500; }
.prop-input {
  width:100%; padding:0.4rem 0.6rem; border:1px solid var(--border); border-radius:4px;
  background:var(--bg); font-family:'DM Sans',sans-serif; font-size:0.82rem; color:var(--text); outline:none;
}
.prop-input:focus { border-color:var(--accent); }
.prop-color { width:100%; height:34px; padding:2px; border:1px solid var(--border); border-radius:4px; cursor:pointer; background:none; }
.prop-empty { padding:2rem 1rem; text-align:center; color:var(--muted); font-size:0.82rem; font-style:italic; }

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.modal-overlay {
  display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1000;
  align-items:center; justify-content:center; backdrop-filter:blur(4px);
}
.modal-overlay.open { display:flex; animation:fadeIn 0.2s ease; }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
.modal {
  background:var(--panel); border-radius:8px; padding:1.5rem; width:90%; max-width:480px;
  box-shadow:0 20px 60px rgba(0,0,0,0.2);
}
.modal h3 { font-family:'Syne',sans-serif; font-size:1rem; font-weight:700; margin-bottom:1rem; }
.modal input, .modal textarea {
  width:100%; padding:0.5rem 0.75rem; border:1px solid var(--border); border-radius:4px;
  font-family:'DM Sans',sans-serif; font-size:0.9rem; color:var(--text); background:var(--bg); outline:none; margin-bottom:0.75rem;
}
.modal input:focus, .modal textarea:focus { border-color:var(--accent); }
.modal-btns { display:flex; gap:0.5rem; justify-content:flex-end; margin-top:0.5rem; }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
#toast {
  position:fixed; bottom:2rem; left:50%; transform:translateX(-50%) translateY(10px);
  background:var(--accent); color:var(--accent-inv); padding:0.6rem 1.5rem; border-radius:999px;
  font-size:0.82rem; font-weight:500; opacity:0; transition:all 0.3s; pointer-events:none; z-index:2000;
}
#toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

/* ‚îÄ‚îÄ DRAG DROP ‚îÄ‚îÄ */
.drop-indicator { height:3px; background:var(--blue); border-radius:2px; margin:2px 0; display:none; }
.drop-indicator.visible { display:block; }

/* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
::-webkit-scrollbar { width:5px; height:5px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:99px; }
</style>
</head>
<body>

<!-- TOPBAR -->
<div id="topbar">
  <div class="brand">Folio<span>.build</span></div>
  <div class="topbar-center" id="pageTabs"></div>
  <div class="topbar-right">
    <button class="btn-sm" id="previewBtn">Preview</button>
    <button class="btn-sm btn-primary" id="exportBtn">Export HTML</button>
  </div>
</div>

<!-- WORKSPACE -->
<div id="workspace">

  <!-- LEFT SIDEBAR -->
  <div id="sidebar">
    <div class="sidebar-tabs">
      <button class="stab active" data-tab="blocks">Blocks</button>
      <button class="stab" data-tab="theme">Theme</button>
      <button class="stab" data-tab="pages">Pages</button>
    </div>

    <!-- BLOCKS PANEL -->
    <div class="sidebar-panel active" id="tab-blocks">
      <div style="font-family:'Syne',sans-serif;font-size:0.68rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--muted);margin-bottom:0.6rem;">Layout</div>
      <div class="block-grid" id="blockPalette">
        <div class="block-item" data-block-type="hero" draggable="true"><div class="block-icon">ü¶∏</div><div class="block-label">Hero</div></div>
        <div class="block-item" data-block-type="nav" draggable="true"><div class="block-icon">üîó</div><div class="block-label">Nav Bar</div></div>
        <div class="block-item" data-block-type="heading" draggable="true"><div class="block-icon">H</div><div class="block-label">Heading</div></div>
        <div class="block-item" data-block-type="text" draggable="true"><div class="block-icon">¬∂</div><div class="block-label">Text</div></div>
        <div class="block-item" data-block-type="image" draggable="true"><div class="block-icon">üñº</div><div class="block-label">Image</div></div>
        <div class="block-item" data-block-type="cols2" draggable="true"><div class="block-icon">‚äü</div><div class="block-label">2 Columns</div></div>
        <div class="block-item" data-block-type="cols3" draggable="true"><div class="block-icon">‚äû</div><div class="block-label">3 Columns</div></div>
        <div class="block-item" data-block-type="card" draggable="true"><div class="block-icon">üÉè</div><div class="block-label">Card</div></div>
        <div class="block-item" data-block-type="quote" draggable="true"><div class="block-icon">"</div><div class="block-label">Quote</div></div>
        <div class="block-item" data-block-type="divider" draggable="true"><div class="block-icon">‚îÄ</div><div class="block-label">Divider</div></div>
        <div class="block-item" data-block-type="spacer" draggable="true"><div class="block-icon">‚Üï</div><div class="block-label">Spacer</div></div>
        <div class="block-item" data-block-type="footer" draggable="true"><div class="block-icon">ü¶∂</div><div class="block-label">Footer</div></div>
      </div>
    </div>

    <!-- THEME PANEL -->
    <div class="sidebar-panel" id="tab-theme">
      <div class="theme-section">
        <span class="theme-label">Background Color</span>
        <div class="color-row" id="bgSwatches">
          <div class="color-swatch active" style="background:#ffffff" data-color="#ffffff" data-target="bg" title="White"></div>
          <div class="color-swatch" style="background:#f5f3ef" data-color="#f5f3ef" data-target="bg" title="Cream"></div>
          <div class="color-swatch" style="background:#0d0d0e" data-color="#0d0d0e" data-target="bg" title="Black"></div>
          <div class="color-swatch" style="background:#1a2744" data-color="#1a2744" data-target="bg" title="Navy"></div>
          <div class="color-swatch" style="background:#1c2b1e" data-color="#1c2b1e" data-target="bg" title="Forest"></div>
          <div class="color-swatch" style="background:#2d1b3e" data-color="#2d1b3e" data-target="bg" title="Plum"></div>
        </div>
        <div class="color-custom">
          <input type="color" id="bgCustom" value="#ffffff">
          <label>Custom</label>
        </div>
      </div>

      <div class="theme-section">
        <span class="theme-label">Text Color</span>
        <div class="color-row" id="textSwatches">
          <div class="color-swatch active" style="background:#1a1814" data-color="#1a1814" data-target="text" title="Dark"></div>
          <div class="color-swatch" style="background:#f5f3ef" data-color="#f5f3ef" data-target="text" title="Light"></div>
          <div class="color-swatch" style="background:#2563eb" data-color="#2563eb" data-target="text" title="Blue"></div>
          <div class="color-swatch" style="background:#d94f3d" data-color="#d94f3d" data-target="text" title="Red"></div>
          <div class="color-swatch" style="background:#2d7d52" data-color="#2d7d52" data-target="text" title="Green"></div>
          <div class="color-swatch" style="background:#c9a96e" data-color="#c9a96e" data-target="text" title="Gold"></div>
        </div>
        <div class="color-custom">
          <input type="color" id="textCustom" value="#1a1814">
          <label>Custom</label>
        </div>
      </div>

      <div class="theme-section">
        <span class="theme-label">Font Family</span>
        <select class="font-select" id="fontSelect">
          <option value="Georgia, serif">Georgia (Serif)</option>
          <option value="'Playfair Display', Georgia, serif">Playfair Display</option>
          <option value="'DM Sans', system-ui, sans-serif">DM Sans</option>
          <option value="'Syne', system-ui, sans-serif">Syne</option>
          <option value="'Courier New', monospace">Courier New (Mono)</option>
          <option value="Garamond, 'Times New Roman', serif">Garamond</option>
          <option value="Helvetica, Arial, sans-serif">Helvetica</option>
          <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
        </select>
      </div>

      <div class="theme-section">
        <span class="theme-label">Content Width</span>
        <select class="select-input" id="widthSelect">
          <option value="680px">Narrow (680px)</option>
          <option value="860px" selected>Medium (860px)</option>
          <option value="1100px">Wide (1100px)</option>
          <option value="100%">Full Width</option>
        </select>
      </div>

      <div class="theme-section">
        <span class="theme-label">Font Size</span>
        <div class="range-row">
          <input type="range" id="fontSizeRange" min="12" max="22" value="16" step="1">
          <span class="range-val" id="fontSizeVal">16px</span>
        </div>
      </div>

      <div class="theme-section">
        <span class="theme-label">Line Height</span>
        <div class="range-row">
          <input type="range" id="lineHeightRange" min="1.2" max="2.2" value="1.7" step="0.1">
          <span class="range-val" id="lineHeightVal">1.7</span>
        </div>
      </div>

      <div class="theme-section">
        <span class="theme-label">Page Padding</span>
        <div class="range-row">
          <input type="range" id="paddingRange" min="0" max="80" value="32" step="4">
          <span class="range-val" id="paddingVal">32px</span>
        </div>
      </div>
    </div>

    <!-- PAGES PANEL -->
    <div class="sidebar-panel" id="tab-pages">
      <div id="pageList"></div>
      <button class="add-page-btn" id="addPageBtn">+ Add Page</button>
    </div>
  </div>

  <!-- MAIN EDITOR AREA -->
  <div style="flex:1;display:flex;flex-direction:column;overflow:hidden;">
    <div id="toolbar-wrap">
      <div id="toolbar">
        <select class="tb-select" id="blockFormatSelect">
          <option value="p">Paragraph</option>
          <option value="h1">Heading 1</option>
          <option value="h2">Heading 2</option>
          <option value="h3">Heading 3</option>
          <option value="h4">Heading 4</option>
          <option value="blockquote">Quote</option>
          <option value="pre">Code</option>
        </select>
        <div class="tb-sep"></div>
        <button class="tb-btn" id="tbBold" title="Bold"><b>B</b></button>
        <button class="tb-btn" id="tbItalic" title="Italic"><i>I</i></button>
        <button class="tb-btn" id="tbUnderline" title="Underline"><u>U</u></button>
        <button class="tb-btn" id="tbStrike" title="Strikethrough"><s>S</s></button>
        <div class="tb-sep"></div>
        <button class="tb-btn" id="tbUL" title="Bullet list">‚â°</button>
        <button class="tb-btn" id="tbOL" title="Numbered list">‚ãÆ</button>
        <div class="tb-sep"></div>
        <button class="tb-btn" id="tbAlignL" title="Align left">‚¨§‚óª‚óª</button>
        <button class="tb-btn" id="tbAlignC" title="Center">‚óª‚¨§‚óª</button>
        <button class="tb-btn" id="tbAlignR" title="Align right">‚óª‚óª‚¨§</button>
        <div class="tb-sep"></div>
        <button class="tb-btn" id="tbLink" title="Insert link">üîó</button>
        <button class="tb-btn" id="tbImg" title="Insert image">üñº</button>
        <div class="tb-sep"></div>
        <input type="color" class="tb-color" id="tbTextColor" title="Text color" value="#1a1814">
        <input type="color" class="tb-color" id="tbBgColor" title="Highlight color" value="#ffffff">
        <div class="tb-sep"></div>
        <button class="tb-btn" id="tbUndo" title="Undo">‚Ü©</button>
        <button class="tb-btn" id="tbRedo" title="Redo">‚Ü™</button>
      </div>
    </div>

    <div id="canvas-wrap">
      <div id="preview-frame">
        <div id="canvas" contenteditable="true" spellcheck="true"></div>
      </div>
    </div>
  </div>

  <!-- RIGHT PROPS PANEL -->
  <div id="props-panel">
    <div class="props-header"><div class="props-title">Properties</div></div>
    <div class="props-body" id="propsBody">
      <div class="prop-empty">Select a block to edit its properties.</div>
    </div>
  </div>

</div>

<!-- LINK MODAL -->
<div class="modal-overlay" id="linkModal">
  <div class="modal">
    <h3>Insert Link</h3>
    <input type="text" id="linkText" placeholder="Link text">
    <input type="url" id="linkUrl" placeholder="https://‚Ä¶">
    <div class="modal-btns">
      <button class="btn-sm" id="linkCancel">Cancel</button>
      <button class="btn-sm btn-primary" id="linkInsert">Insert</button>
    </div>
  </div>
</div>

<!-- IMAGE MODAL -->
<div class="modal-overlay" id="imgModal">
  <div class="modal">
    <h3>Insert Image</h3>
    <input type="url" id="imgUrl" placeholder="Image URL (https://‚Ä¶)">
    <div style="text-align:center;margin:0.5rem 0;color:var(--muted);font-size:0.8rem;">‚Äî or ‚Äî</div>
    <input type="file" id="imgFile" accept="image/*" style="margin-bottom:0.75rem;">
    <input type="text" id="imgAlt" placeholder="Alt text (optional)">
    <div class="modal-btns">
      <button class="btn-sm" id="imgCancel">Cancel</button>
      <button class="btn-sm btn-primary" id="imgInsert">Insert</button>
    </div>
  </div>
</div>

<!-- PAGE NAME MODAL -->
<div class="modal-overlay" id="pageModal">
  <div class="modal">
    <h3>New Page</h3>
    <input type="text" id="pageNameInput" placeholder="Page name (e.g. About)">
    <div class="modal-btns">
      <button class="btn-sm" id="pageCancel">Cancel</button>
      <button class="btn-sm btn-primary" id="pageCreate">Create</button>
    </div>
  </div>
</div>

<!-- PREVIEW MODAL -->
<div class="modal-overlay" id="previewModal" style="align-items:stretch;padding:1rem;">
  <div style="background:#fff;border-radius:8px;display:flex;flex-direction:column;width:100%;max-width:960px;margin:auto;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.25);">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:0.75rem 1rem;border-bottom:1px solid var(--border);background:var(--panel);">
      <span style="font-family:'Syne',sans-serif;font-size:0.75rem;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;color:var(--muted);">Preview</span>
      <button class="btn-sm" id="previewClose">Close</button>
    </div>
    <iframe id="previewIframe" style="flex:1;border:none;min-height:500px;"></iframe>
  </div>
</div>

<div id="toast"></div>

<script>
(function () {
'use strict';

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
var state = {
  pages: [{ id: 'home', name: 'Home', content: '' }],
  activePage: 'home',
  theme: {
    bg: '#ffffff',
    color: '#1a1814',
    font: 'Georgia, serif',
    fontSize: '16px',
    lineHeight: '1.7',
    padding: '32px',
    maxWidth: '860px'
  }
};

// ‚îÄ‚îÄ DOM REFS ‚îÄ‚îÄ
var canvas = document.getElementById('canvas');
var pageTabs = document.getElementById('pageTabs');
var pageList = document.getElementById('pageList');
var propsBody = document.getElementById('propsBody');
var blockFormatSelect = document.getElementById('blockFormatSelect');

// ‚îÄ‚îÄ BLOCK TEMPLATES ‚îÄ‚îÄ
var blockTemplates = {
  hero: function() {
    return '<div data-block="hero" class="hero-block" contenteditable="true">' +
      '<h1>Your Headline Here</h1>' +
      '<p>Write a compelling subtitle that explains what you do or offer.</p>' +
      '<a class="hero-btn" href="#">Get Started</a>' +
      '<div class="block-controls">' +
        '<button class="bc-btn" data-action="up" title="Move up">‚Üë</button>' +
        '<button class="bc-btn" data-action="down" title="Move down">‚Üì</button>' +
        '<button class="bc-btn" data-action="delete" title="Delete">‚úï</button>' +
      '</div></div>';
  },
  nav: function() {
    return '<div data-block="nav" class="nav-block" contenteditable="true">' +
      '<span class="nav-logo">Your Brand</span>' +
      '<div class="nav-links"><span>Home</span><span>About</span><span>Contact</span></div>' +
      '<div class="block-controls">' +
        '<button class="bc-btn" data-action="up">‚Üë</button>' +
        '<button class="bc-btn" data-action="down">‚Üì</button>' +
        '<button class="bc-btn" data-action="delete">‚úï</button>' +
      '</div></div>';
  },
  heading: function() {
    return '<div data-block="heading" contenteditable="true">' +
      '<h2>Section Heading</h2>' +
      '<div class="block-controls">' +
        '<button class="bc-btn" data-action="up">‚Üë</button>' +
        '<button class="bc-btn" data-action="down">‚Üì</button>' +
        '<button class="bc-btn" data-action="delete">‚úï</button>' +
      '</div></div>';
  },
  text: function() {
    return '<div data-block="text" contenteditable="true">' +
      '<p>Click here to start writing. You can edit this text directly and use the toolbar above to format it.</p>' +
      '<div class="block-controls">' +
        '<button class="bc-btn" data-action="up">‚Üë</button>' +
        '<button class="bc-btn" data-action="down">‚Üì</button>' +
        '<button class="bc-btn" data-action="delete">‚úï</button>' +
      '</div></div>';
  },
  image: function() {
    return '<div data-block="image" class="img-block">' +
      '<img src="https://images.unsplash.com/photo-1497366216548-37526070297c?w=860&q=80" alt="Image">' +
      '<div class="block-controls">' +
        '<button class="bc-btn" data-action="up">‚Üë</button>' +
        '<button class="bc-btn" data-action="down">‚Üì</button>' +
        '<button class="bc-btn" data-action="delete">‚úï</button>' +
      '</div></div>';
  },
  cols2: function() {
    return '<div data-block="cols2" class="cols-block">' +
      '<div contenteditable="true" style="min-height:60px;"><p>Left column content</p></div>' +
      '<div contenteditable="true" style="min-height:60px;"><p>Right column content</p></div>' +
      '<div class="block-controls">' +
        '<button class="bc-btn" data-action="up">‚Üë</button>' +
        '<button class="bc-btn" data-action="down">‚Üì</button>' +
        '<button class="bc-btn" data-action="delete">‚úï</button>' +
      '</div></div>';
  },
  cols3: function() {
    return '<div data-block="cols3" class="cols-block-3">' +
      '<div contenteditable="true" style="min-height:60px;"><p>Column one</p></div>' +
      '<div contenteditable="true" style="min-height:60px;"><p>Column two</p></div>' +
      '<div contenteditable="true" style="min-height:60px;"><p>Column three</p></div>' +
      '<div class="block-controls">' +
        '<button class="bc-btn" data-action="up">‚Üë</button>' +
        '<button class="bc-btn" data-action="down">‚Üì</button>' +
        '<button class="bc-btn" data-action="delete">‚úï</button>' +
      '</div></div>';
  },
  card: function() {
    return '<div data-block="card" class="card-block" contenteditable="true">' +
      '<h3>Card Title</h3><p>Card content goes here. Great for features, testimonials, or highlights.</p>' +
      '<div class="block-controls">' +
        '<button class="bc-btn" data-action="up">‚Üë</button>' +
        '<button class="bc-btn" data-action="down">‚Üì</button>' +
        '<button class="bc-btn" data-action="delete">‚úï</button>' +
      '</div></div>';
  },
  quote: function() {
    return '<div data-block="quote" contenteditable="true">' +
      '<blockquote>A memorable quote or highlighted insight goes here.</blockquote>' +
      '<div class="block-controls">' +
        '<button class="bc-btn" data-action="up">‚Üë</button>' +
        '<button class="bc-btn" data-action="down">‚Üì</button>' +
        '<button class="bc-btn" data-action="delete">‚úï</button>' +
      '</div></div>';
  },
  divider: function() {
    return '<div data-block="divider" class="divider-block"><hr>' +
      '<div class="block-controls">' +
        '<button class="bc-btn" data-action="up">‚Üë</button>' +
        '<button class="bc-btn" data-action="down">‚Üì</button>' +
        '<button class="bc-btn" data-action="delete">‚úï</button>' +
      '</div></div>';
  },
  spacer: function() {
    return '<div data-block="spacer" class="spacer-block">' +
      '<div class="block-controls">' +
        '<button class="bc-btn" data-action="up">‚Üë</button>' +
        '<button class="bc-btn" data-action="down">‚Üì</button>' +
        '<button class="bc-btn" data-action="delete">‚úï</button>' +
      '</div></div>';
  },
  footer: function() {
    return '<div data-block="footer" class="footer-block" contenteditable="true">' +
      '<p>¬© 2024 Your Brand. All rights reserved.</p>' +
      '<div class="block-controls">' +
        '<button class="bc-btn" data-action="up">‚Üë</button>' +
        '<button class="bc-btn" data-action="down">‚Üì</button>' +
        '<button class="bc-btn" data-action="delete">‚úï</button>' +
      '</div></div>';
  }
};

// ‚îÄ‚îÄ APPLY THEME ‚îÄ‚îÄ
function applyTheme() {
  var t = state.theme;
  canvas.style.setProperty('--cbg', t.bg);
  canvas.style.setProperty('--cc', t.color);
  canvas.style.setProperty('--cf', t.font);
  canvas.style.backgroundColor = t.bg;
  canvas.style.color = t.color;
  canvas.style.fontFamily = t.font;
  canvas.style.fontSize = t.fontSize;
  canvas.style.lineHeight = t.lineHeight;
  canvas.style.padding = t.padding;
  canvas.style.maxWidth = t.maxWidth;
  canvas.style.margin = '0 auto';
}

// ‚îÄ‚îÄ RENDER PAGES ‚îÄ‚îÄ
function renderPageTabs() {
  pageTabs.innerHTML = '';
  state.pages.forEach(function(page) {
    var btn = document.createElement('button');
    btn.className = 'page-tab' + (page.id === state.activePage ? ' active' : '');
    btn.textContent = page.name;
    btn.addEventListener('click', function() { switchPage(page.id); });
    pageTabs.appendChild(btn);
  });
  var add = document.createElement('button');
  add.className = 'page-tab-add';
  add.textContent = '+';
  add.title = 'Add page';
  add.addEventListener('click', function() { openModal('pageModal'); });
  pageTabs.appendChild(add);
}

function renderPageList() {
  pageList.innerHTML = '';
  state.pages.forEach(function(page) {
    var item = document.createElement('div');
    item.className = 'page-item' + (page.id === state.activePage ? ' active' : '');
    item.innerHTML = '<span class="page-item-name">' + page.name + '</span>';
    if (state.pages.length > 1) {
      var del = document.createElement('button');
      del.className = 'page-del';
      del.textContent = '‚úï';
      del.title = 'Delete page';
      del.addEventListener('click', function(e) { e.stopPropagation(); deletePage(page.id); });
      item.appendChild(del);
    }
    item.addEventListener('click', function() { switchPage(page.id); });
    pageList.appendChild(item);
  });
}

function switchPage(id) {
  saveCurrent();
  state.activePage = id;
  var page = state.pages.find(function(p) { return p.id === id; });
  canvas.innerHTML = page ? page.content : '';
  renderPageTabs();
  renderPageList();
  clearSelection();
}

function saveCurrent() {
  var page = state.pages.find(function(p) { return p.id === state.activePage; });
  if (page) page.content = canvas.innerHTML;
}

function deletePage(id) {
  if (state.pages.length <= 1) return;
  state.pages = state.pages.filter(function(p) { return p.id !== id; });
  if (state.activePage === id) state.activePage = state.pages[0].id;
  switchPage(state.activePage);
}

// ‚îÄ‚îÄ BLOCK INSERTION ‚îÄ‚îÄ
function insertBlock(type) {
  var tmpl = blockTemplates[type];
  if (!tmpl) return;
  var div = document.createElement('div');
  div.innerHTML = tmpl();
  var block = div.firstChild;
  canvas.appendChild(block);
  block.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  showToast('Block added');
}

// ‚îÄ‚îÄ BLOCK CONTROLS ‚îÄ‚îÄ
canvas.addEventListener('click', function(e) {
  var actionBtn = e.target.closest('[data-action]');
  if (actionBtn) {
    e.preventDefault(); e.stopPropagation();
    var block = actionBtn.closest('[data-block]');
    var action = actionBtn.getAttribute('data-action');
    if (action === 'delete') { block.remove(); clearSelection(); saveCurrent(); }
    else if (action === 'up' && block.previousElementSibling) { canvas.insertBefore(block, block.previousElementSibling); }
    else if (action === 'down' && block.nextElementSibling) { canvas.insertBefore(block.nextElementSibling, block); }
    return;
  }
  var block = e.target.closest('[data-block]');
  selectBlock(block);
});

var selectedBlock = null;
function selectBlock(block) {
  document.querySelectorAll('#canvas [data-block]').forEach(function(b) { b.classList.remove('selected'); });
  selectedBlock = block;
  if (block) {
    block.classList.add('selected');
    renderProps(block);
  } else {
    clearSelection();
  }
}

function clearSelection() {
  document.querySelectorAll('#canvas [data-block]').forEach(function(b) { b.classList.remove('selected'); });
  selectedBlock = null;
  propsBody.innerHTML = '<div class="prop-empty">Select a block to edit its properties.</div>';
}

// ‚îÄ‚îÄ PROPERTIES PANEL ‚îÄ‚îÄ
function renderProps(block) {
  var type = block.getAttribute('data-block');
  var html = '<div class="prop-row"><span class="prop-label">Block Type</span><input class="prop-input" value="' + type + '" readonly></div>';

  // Background color prop
  var bg = block.style.backgroundColor || '';
  html += '<div class="prop-row"><span class="prop-label">Background</span><input type="color" class="prop-color" id="propBg" value="' + (bg ? rgbToHex(bg) : '#ffffff') + '"></div>';

  // Padding prop
  var pad = block.style.padding || '';
  html += '<div class="prop-row"><span class="prop-label">Padding</span><input class="prop-input" id="propPad" value="' + pad + '" placeholder="e.g. 2rem"></div>';

  // Border radius
  var br = block.style.borderRadius || '';
  html += '<div class="prop-row"><span class="prop-label">Border Radius</span><input class="prop-input" id="propBr" value="' + br + '" placeholder="e.g. 8px"></div>';

  // Text align
  var ta = block.style.textAlign || 'left';
  html += '<div class="prop-row"><span class="prop-label">Text Align</span><select class="prop-input" id="propAlign"><option value="left">Left</option><option value="center">Center</option><option value="right">Right</option></select></div>';

  // Image src if image block
  if (type === 'image') {
    var img = block.querySelector('img');
    if (img) {
      html += '<div class="prop-row"><span class="prop-label">Image URL</span><input class="prop-input" id="propImgSrc" value="' + (img.src || '') + '"></div>';
      html += '<div class="prop-row"><span class="prop-label">Alt Text</span><input class="prop-input" id="propImgAlt" value="' + (img.alt || '') + '"></div>';
    }
  }

  propsBody.innerHTML = html;

  // Restore align select
  var alignSel = document.getElementById('propAlign');
  if (alignSel) { alignSel.value = ta; alignSel.addEventListener('change', function() { block.style.textAlign = this.value; }); }

  var bgInput = document.getElementById('propBg');
  if (bgInput) bgInput.addEventListener('input', function() { block.style.backgroundColor = this.value; });

  var padInput = document.getElementById('propPad');
  if (padInput) padInput.addEventListener('change', function() { block.style.padding = this.value; });

  var brInput = document.getElementById('propBr');
  if (brInput) brInput.addEventListener('change', function() { block.style.borderRadius = this.value; });

  var srcInput = document.getElementById('propImgSrc');
  if (srcInput) srcInput.addEventListener('change', function() { var img = block.querySelector('img'); if(img) img.src = this.value; });

  var altInput = document.getElementById('propImgAlt');
  if (altInput) altInput.addEventListener('change', function() { var img = block.querySelector('img'); if(img) img.alt = this.value; });
}

function rgbToHex(rgb) {
  var result = rgb.match(/\d+/g);
  if (!result) return '#ffffff';
  return '#' + result.slice(0,3).map(function(n) { return ('0' + parseInt(n).toString(16)).slice(-2); }).join('');
}

// ‚îÄ‚îÄ DRAG & DROP FROM PALETTE ‚îÄ‚îÄ
var dragType = null;

document.querySelectorAll('.block-item').forEach(function(item) {
  item.addEventListener('dragstart', function(e) {
    dragType = item.getAttribute('data-block-type');
    e.dataTransfer.effectAllowed = 'copy';
  });
  item.addEventListener('dragend', function() { dragType = null; });
});

canvas.addEventListener('dragover', function(e) {
  if (!dragType) return;
  e.preventDefault();
  e.dataTransfer.dropEffect = 'copy';
});

canvas.addEventListener('drop', function(e) {
  if (!dragType) return;
  e.preventDefault();
  insertBlock(dragType);
  dragType = null;
});

// ‚îÄ‚îÄ BLOCK PALETTE CLICK ‚îÄ‚îÄ
document.querySelectorAll('.block-item').forEach(function(item) {
  item.addEventListener('click', function() {
    insertBlock(item.getAttribute('data-block-type'));
  });
});

// ‚îÄ‚îÄ SIDEBAR TABS ‚îÄ‚îÄ
document.querySelectorAll('.stab').forEach(function(tab) {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.stab').forEach(function(t) { t.classList.remove('active'); });
    document.querySelectorAll('.sidebar-panel').forEach(function(p) { p.classList.remove('active'); });
    tab.classList.add('active');
    document.getElementById('tab-' + tab.getAttribute('data-tab')).classList.add('active');
  });
});

// ‚îÄ‚îÄ THEME CONTROLS ‚îÄ‚îÄ
function setupSwatches(selector, target) {
  document.querySelectorAll(selector).forEach(function(sw) {
    sw.addEventListener('click', function() {
      document.querySelectorAll(selector).forEach(function(s) { s.classList.remove('active'); });
      sw.classList.add('active');
      state.theme[target] = sw.getAttribute('data-color');
      applyTheme();
    });
  });
}
setupSwatches('[data-target="bg"]', 'bg');
setupSwatches('[data-target="text"]', 'color');

document.getElementById('bgCustom').addEventListener('input', function() {
  state.theme.bg = this.value;
  document.querySelectorAll('[data-target="bg"]').forEach(function(s) { s.classList.remove('active'); });
  applyTheme();
});

document.getElementById('textCustom').addEventListener('input', function() {
  state.theme.color = this.value;
  document.querySelectorAll('[data-target="text"]').forEach(function(s) { s.classList.remove('active'); });
  applyTheme();
});

document.getElementById('fontSelect').addEventListener('change', function() {
  state.theme.font = this.value;
  applyTheme();
});

document.getElementById('widthSelect').addEventListener('change', function() {
  state.theme.maxWidth = this.value;
  applyTheme();
});

function setupRange(rangeId, valId, themeKey, unit) {
  var range = document.getElementById(rangeId);
  var val = document.getElementById(valId);
  range.addEventListener('input', function() {
    var v = this.value + (unit || '');
    val.textContent = v;
    state.theme[themeKey] = v;
    applyTheme();
  });
}
setupRange('fontSizeRange', 'fontSizeVal', 'fontSize', 'px');
setupRange('lineHeightRange', 'lineHeightVal', 'lineHeight', '');
setupRange('paddingRange', 'paddingVal', 'padding', 'px');

// ‚îÄ‚îÄ TOOLBAR ACTIONS ‚îÄ‚îÄ
function tbCmd(cmd, val) {
  canvas.focus();
  document.execCommand(cmd, false, val || null);
}

document.getElementById('tbBold').addEventListener('click', function() { tbCmd('bold'); });
document.getElementById('tbItalic').addEventListener('click', function() { tbCmd('italic'); });
document.getElementById('tbUnderline').addEventListener('click', function() { tbCmd('underline'); });
document.getElementById('tbStrike').addEventListener('click', function() { tbCmd('strikeThrough'); });
document.getElementById('tbUL').addEventListener('click', function() { tbCmd('insertUnorderedList'); });
document.getElementById('tbOL').addEventListener('click', function() { tbCmd('insertOrderedList'); });
document.getElementById('tbAlignL').addEventListener('click', function() { tbCmd('justifyLeft'); });
document.getElementById('tbAlignC').addEventListener('click', function() { tbCmd('justifyCenter'); });
document.getElementById('tbAlignR').addEventListener('click', function() { tbCmd('justifyRight'); });
document.getElementById('tbUndo').addEventListener('click', function() { tbCmd('undo'); });
document.getElementById('tbRedo').addEventListener('click', function() { tbCmd('redo'); });

document.getElementById('tbTextColor').addEventListener('input', function() { tbCmd('foreColor', this.value); });
document.getElementById('tbBgColor').addEventListener('input', function() { tbCmd('hiliteColor', this.value); });

blockFormatSelect.addEventListener('change', function() {
  tbCmd('formatBlock', '<' + this.value + '>');
});

// ‚îÄ‚îÄ LINK MODAL ‚îÄ‚îÄ
var savedRange = null;
document.getElementById('tbLink').addEventListener('click', function() {
  var sel = window.getSelection();
  if (sel.rangeCount) savedRange = sel.getRangeAt(0).cloneRange();
  var selText = sel.toString();
  document.getElementById('linkText').value = selText;
  document.getElementById('linkUrl').value = '';
  openModal('linkModal');
});
document.getElementById('linkCancel').addEventListener('click', function() { closeModal('linkModal'); });
document.getElementById('linkInsert').addEventListener('click', function() {
  var url = document.getElementById('linkUrl').value.trim();
  var text = document.getElementById('linkText').value.trim();
  if (!url) return;
  canvas.focus();
  if (savedRange) {
    var sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(savedRange);
  }
  tbCmd('createLink', url);
  closeModal('linkModal');
  savedRange = null;
});

// ‚îÄ‚îÄ IMAGE MODAL ‚îÄ‚îÄ
document.getElementById('tbImg').addEventListener('click', function() { openModal('imgModal'); });
document.getElementById('imgCancel').addEventListener('click', function() { closeModal('imgModal'); });
document.getElementById('imgInsert').addEventListener('click', function() {
  var url = document.getElementById('imgUrl').value.trim();
  var alt = document.getElementById('imgAlt').value.trim();
  var file = document.getElementById('imgFile').files[0];

  function doInsert(src) {
    canvas.focus();
    var img = '<img src="' + src + '" alt="' + alt + '" style="max-width:100%;">';
    tbCmd('insertHTML', img);
    closeModal('imgModal');
    document.getElementById('imgUrl').value = '';
    document.getElementById('imgAlt').value = '';
    document.getElementById('imgFile').value = '';
  }

  if (file) {
    var reader = new FileReader();
    reader.onload = function(e) { doInsert(e.target.result); };
    reader.readAsDataURL(file);
  } else if (url) {
    doInsert(url);
  }
});

// ‚îÄ‚îÄ PAGE MODAL ‚îÄ‚îÄ
document.getElementById('addPageBtn').addEventListener('click', function() { openModal('pageModal'); });
document.getElementById('pageCancel').addEventListener('click', function() { closeModal('pageModal'); });
document.getElementById('pageCreate').addEventListener('click', function() {
  var name = document.getElementById('pageNameInput').value.trim();
  if (!name) return;
  var id = name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
  state.pages.push({ id: id, name: name, content: '' });
  closeModal('pageModal');
  document.getElementById('pageNameInput').value = '';
  switchPage(id);
  showToast('Page "' + name + '" created');
});

// ‚îÄ‚îÄ PREVIEW ‚îÄ‚îÄ
document.getElementById('previewBtn').addEventListener('click', function() {
  saveCurrent();
  var html = buildExport(true);
  var iframe = document.getElementById('previewIframe');
  iframe.srcdoc = html;
  openModal('previewModal');
});
document.getElementById('previewClose').addEventListener('click', function() { closeModal('previewModal'); });

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ
document.getElementById('exportBtn').addEventListener('click', function() {
  saveCurrent();
  var html = buildExport(false);
  var blob = new Blob([html], { type: 'text/html' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'site.html';
  a.click();
  URL.revokeObjectURL(url);
  showToast('Exported as site.html');
});

// ‚îÄ‚îÄ BUILD EXPORT ‚îÄ‚îÄ
function buildExport(isPreview) {
  var t = state.theme;

  // Build nav links for multi-page
  var navLinks = state.pages.map(function(p, i) {
    return '<a href="' + (i === 0 ? '#' : '#page-' + p.id) + '" onclick="showPage(\'' + p.id + '\');return false;">' + p.name + '</a>';
  }).join('\n      ');

  // Build page sections - strip block-controls from export
  var sections = state.pages.map(function(p) {
    var div = document.createElement('div');
    div.innerHTML = p.content;
    // Remove editor controls from exported html
    div.querySelectorAll('.block-controls').forEach(function(bc) { bc.remove(); });
    // Remove selected/hover classes
    div.querySelectorAll('[data-block]').forEach(function(b) {
      b.classList.remove('selected');
      b.removeAttribute('contenteditable');
    });
    div.querySelectorAll('[contenteditable]').forEach(function(el) {
      el.removeAttribute('contenteditable');
    });
    return '<section id="page-' + p.id + '" class="site-page">' + div.innerHTML + '</section>';
  }).join('\n');

  return '<!DOCTYPE html>\n<html lang="en">\n<head>\n' +
    '<meta charset="UTF-8">\n' +
    '<meta name="viewport" content="width=device-width, initial-scale=1.0">\n' +
    '<title>' + (state.pages[0] ? state.pages[0].name : 'My Site') + '</title>\n' +
    (t.font.includes('Playfair') ? '<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">\n' : '') +
    (t.font.includes('DM Sans') ? '<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">\n' : '') +
    (t.font.includes('Syne') ? '<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">\n' : '') +
    '<style>\n' +
    '*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }\n' +
    'body { font-family:' + t.font + '; background:' + t.bg + '; color:' + t.color + '; font-size:' + t.fontSize + '; line-height:' + t.lineHeight + '; }\n' +
    '.site-nav { display:flex; align-items:center; justify-content:space-between; padding:1rem 2rem; border-bottom:1px solid rgba(128,128,128,0.2); }\n' +
    '.site-nav a { color:inherit; text-decoration:none; font-weight:500; cursor:pointer; }\n' +
    '.site-nav .nav-links { display:flex; gap:2rem; }\n' +
    '.site-page { display:none; }\n' +
    '.site-page.active { display:block; }\n' +
    '.content-wrap { max-width:' + t.maxWidth + '; margin:0 auto; padding:' + t.padding + '; }\n' +
    'h1 { font-size:2.4em; font-weight:700; line-height:1.15; margin-bottom:0.5rem; }\n' +
    'h2 { font-size:1.8em; font-weight:600; line-height:1.2; margin-bottom:0.5rem; }\n' +
    'h3 { font-size:1.3em; font-weight:600; margin-bottom:0.4rem; }\n' +
    'p { margin-bottom:1rem; }\n' +
    'ul, ol { margin-left:1.5rem; margin-bottom:1rem; }\n' +
    'img { max-width:100%; border-radius:4px; display:block; }\n' +
    'hr { border:none; border-top:1px solid rgba(128,128,128,0.2); margin:1.5rem 0; }\n' +
    'blockquote { border-left:3px solid currentColor; padding-left:1rem; font-style:italic; margin:1rem 0; opacity:0.75; }\n' +
    'a { color:inherit; }\n' +
    '.hero-block { padding:4rem 2rem; text-align:center; }\n' +
    '.hero-block h1 { font-size:3em; margin-bottom:0.75rem; }\n' +
    '.hero-block p { font-size:1.15em; opacity:0.75; max-width:560px; margin:0 auto 1.5rem; }\n' +
    '.hero-btn { display:inline-block; padding:0.75rem 2rem; background:currentColor; border-radius:4px; font-weight:600; text-decoration:none; }\n' +
    '.cols-block { display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; }\n' +
    '.cols-block-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:1.5rem; }\n' +
    '.card-block { border:1px solid rgba(128,128,128,0.2); border-radius:8px; padding:1.5rem; }\n' +
    '.nav-block { display:flex; align-items:center; justify-content:space-between; padding:1rem 0; border-bottom:1px solid rgba(128,128,128,0.2); margin-bottom:1rem; }\n' +
    '.nav-block .nav-logo { font-weight:700; font-size:1.1em; }\n' +
    '.nav-block .nav-links { display:flex; gap:1.5rem; font-size:0.9em; opacity:0.7; }\n' +
    '.footer-block { padding:2rem 0; border-top:1px solid rgba(128,128,128,0.2); margin-top:1rem; text-align:center; opacity:0.6; font-size:0.9em; }\n' +
    '.spacer-block { height:3rem; }\n' +
    '@media (max-width:640px) { .cols-block, .cols-block-3 { grid-template-columns:1fr; } }\n' +
    '</style>\n</head>\n<body>\n' +
    (state.pages.length > 1 ? '<nav class="site-nav"><div class="nav-links">' + navLinks + '</div></nav>\n' : '') +
    '<div class="content-wrap">\n' + sections + '\n</div>\n' +
    '<script>\n' +
    '(function(){\n' +
    '  var pages = ' + JSON.stringify(state.pages.map(function(p) { return p.id; })) + ';\n' +
    '  function showPage(id) {\n' +
    '    document.querySelectorAll(".site-page").forEach(function(p){p.classList.remove("active");});\n' +
    '    var el = document.getElementById("page-"+id);\n' +
    '    if(el) el.classList.add("active");\n' +
    '    window.location.hash = id;\n' +
    '  }\n' +
    '  window.showPage = showPage;\n' +
    '  var hash = window.location.hash.replace("#","") || pages[0];\n' +
    '  showPage(hash);\n' +
    '})();\n' +
    '<\/script>\n</body>\n</html>';
}

// ‚îÄ‚îÄ MODAL HELPERS ‚îÄ‚îÄ
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(function(overlay) {
  overlay.addEventListener('click', function(e) { if (e.target === this) this.classList.remove('open'); });
});

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
var toastTimer;
function showToast(msg) {
  var toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(function() { toast.classList.remove('show'); }, 2200);
}

// ‚îÄ‚îÄ AUTOSAVE ‚îÄ‚îÄ
canvas.addEventListener('input', function() {
  clearTimeout(canvas._saveTimer);
  canvas._saveTimer = setTimeout(saveCurrent, 600);
});

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
applyTheme();
renderPageTabs();
renderPageList();
// Set first page active
if (state.pages.length > 0) {
  document.getElementById('page-' + state.activePage) || null;
}
showToast('Welcome to Folio ‚Äî click a block to begin');

})();
</script>
</body>
</html><div class="admin-panel" id="adminPanel">
  <div class="admin-box">
    <button class="admin-close" id="adminClose">&#215;</button>
    <h2>New Post</h2>
    <p class="sub">Publish to your blog instantly.</p>
    <form id="newPostForm">
      <div class="form-group"><label>Title</label><input type="text" id="newTitle" placeholder="Post title‚Ä¶" required></div>
      <div class="form-group">
        <label>Category</label>
        <select id="newCategory">
          <option>Craft</option><option>Industry</option><option>Process</option><option>Essays</option>
        </select>
      </div>
      <div class="form-group"><label>Excerpt</label><textarea id="newExcerpt" rows="2" placeholder="A short summary for the card‚Ä¶" required></textarea></div>
      <div class="form-group"><label>Body (HTML supported)</label><textarea id="newBody" rows="8" placeholder="Write your post here. You can use &lt;p&gt;, &lt;h2&gt;, &lt;blockquote&gt; tags‚Ä¶" required></textarea></div>
      <div class="form-group"><label>Read time</label><input type="text" id="newRead" value="5 min read"></div>
      <button type="submit" class="btn">Publish Post</button>
    </form>
    <div class="existing-posts">
      <h3>Manage Posts</h3>
      <div id="adminPostList"></div>
    </div>
  </div>
</div>

<footer><p>&copy; 2024 <span>The Margin</span> &mdash; Writing that holds.</p></footer>

<script>
(function () {
  var posts = [
    { id:1, category:'Craft', title:'The Sentence That Changed Everything', excerpt:'On the day I rewrote a single sentence forty-seven times, I finally understood what it meant to edit without mercy and write with complete intention.', body:'<p>There\'s a sentence I return to every time I sit down to edit someone else\'s work. It belongs to a client whose name I won\'t share, from a business report about supply chain logistics. But it taught me everything.</p><p>The original read: <em>"Due to the fact that the system was experiencing issues of a technical nature, deliveries were delayed."</em></p><blockquote>Good writing is not about sounding smart. It is about being understood.</blockquote><h2>The Mechanics of Clarity</h2><p>We spent three hours on that one sentence. Not because the writer was bad ‚Äî but because clarity is hard, and vagueness is seductive. It feels professional to hedge. It feels safe to bury the verb.</p><p>The sentence we ended with: <em>"Technical failures delayed deliveries."</em> Four words. Same meaning. All the weight, none of the fog.</p>', date:'Dec 12, 2024', read:'8 min read' },
    { id:2, category:'Industry', title:'The Quiet Death of the Staff Writer', excerpt:'Publications aren\'t just cutting editorial teams ‚Äî they\'re dismantling the institutional knowledge that makes good journalism possible.', body:'<p>Another week, another round of layoffs. Experienced reporters, editors with decades of institutional knowledge, fact-checkers who remember things the internet has forgotten ‚Äî gone.</p><p>What replaces them? Algorithms, generalists, and the belief that content is fungible.</p><h2>What\'s Actually Being Lost</h2><p>We talk about editorial layoffs in terms of economics. But they obscure what\'s actually being lost: the accumulation of judgment.</p><blockquote>A good editor doesn\'t just fix sentences. They remember what was said last quarter, who contradicted whom, what the record actually shows.</blockquote><p>That knowledge doesn\'t live in a database. It lives in people. And once those people are gone, it\'s gone with them.</p>', date:'Nov 28, 2024', read:'6 min read' },
    { id:3, category:'Process', title:'Writing in Batches: A System That Actually Works', excerpt:'Forget the daily word count. The most productive professional writers I know don\'t write every day ‚Äî they write in concentrated bursts.', body:'<p>Every writing advice column tells you the same thing: write every day. Build the habit. Show up.</p><p>I did this for three years. And I produced more mediocre work, more consistently, than at any other point in my career.</p><h2>The Case for Batch Writing</h2><p>What changed everything was talking to a journalist who had filed more long-form pieces in five years than I had in ten. Her method: three days a week, nothing but writing, from 7am to 1pm, phone off, door closed.</p><blockquote>You don\'t build the muscle of writing by touching it every day. You build it by lifting heavy, then resting.</blockquote>', date:'Nov 14, 2024', read:'5 min read' },
    { id:4, category:'Essays', title:'On Writing Badly on Purpose', excerpt:'The first draft isn\'t supposed to be good. But somewhere along the way, we forgot that permission ‚Äî and it\'s killing our work.', body:'<p>There\'s a version of writing advice that has genuinely harmed an entire generation of writers: your first draft should be free, wild, unedited. Good advice. But most people don\'t follow it.</p><h2>The Critic in the Room</h2><p>Somewhere between intention and execution, the internal critic sneaks in. We write a sentence, wince, rewrite it before moving on.</p><blockquote>The blank page isn\'t writer\'s block. It\'s the fear of being caught in the act of not knowing.</blockquote><p>Write the version you\'d be embarrassed to show anyone. The draft that exists is infinitely more useful than the perfect draft you\'re protecting in your head.</p>', date:'Oct 30, 2024', read:'7 min read' },
    { id:5, category:'Craft', title:'Voice Is Not Style', excerpt:'Style is what you do with words. Voice is what you can\'t help doing ‚Äî and learning to tell the difference is one of writing\'s hardest lessons.', body:'<p>I\'ve worked with writers who produced immaculate sentences whose work was somehow airless. Technically flawless and utterly anonymous.</p><p>And I\'ve worked with writers whose grammar was frequently wrong, whose work I\'d recognize from a hundred yards.</p><h2>Where Voice Lives</h2><p>Voice lives in the choices you make when you\'re not thinking about craft. It lives in what you notice, what you find worth saying.</p><blockquote>Style is a costume. Voice is a skeleton. You can change one. You\'re stuck with the other.</blockquote>', date:'Oct 15, 2024', read:'6 min read' },
    { id:6, category:'Industry', title:'What Clients Don\'t Know About Writers', excerpt:'After a decade of freelance work, here are the things I wish every client understood before the engagement began.', body:'<p>I\'ve been freelancing long enough to have had the same conversation many times with clients who mean well and don\'t quite understand what they\'re buying.</p><h2>Time Is the Product</h2><p>When you hire a writer, you\'re hiring focused attention. That attention is rare, finite, and easily destroyed.</p><blockquote>Writing isn\'t what happens at the keyboard. It\'s what happens in the hours when nothing visible is being produced.</blockquote><h2>Revision Is Part of the Work</h2><p>The first draft is not the deliverable. It\'s the beginning of a conversation. "This isn\'t quite right" is not actionable. "The tone here is too casual for our audience" is.</p>', date:'Sep 22, 2024', read:'9 min read' }
  ];

  var currentCategory = 'all';

  function showPage(name) {
    document.querySelectorAll('.page').forEach(function (p) { p.classList.remove('active'); });
    var el = document.getElementById('page-' + name);
    if (el) el.classList.add('active');
    document.getElementById('navWriting').classList.toggle('active', name === 'home' || name === 'post');
    document.getElementById('navAbout').classList.toggle('active', name === 'about');
    window.scrollTo(0, 0);
  }

  function openPost(idx) {
    var post = posts[idx];
    document.getElementById('postCat').textContent = post.category;
    document.getElementById('postTitle').textContent = post.title;
    document.getElementById('postDate').textContent = post.date;
    document.getElementById('postRead').textContent = post.read;
    document.getElementById('postBody').innerHTML = post.body;
    showPage('post');
  }

  function updateFeatured() {
    if (!posts.length) return;
    var p = posts[0];
    document.getElementById('featuredCat').textContent = p.category;
    document.getElementById('featuredTitle').textContent = p.title;
    document.getElementById('featuredExcerpt').textContent = p.excerpt;
    document.getElementById('featuredMeta').innerHTML = '<span>' + p.date + '</span><span>' + p.read + '</span>';
  }

  function renderGrid() {
    var grid = document.getElementById('postsGrid');
    grid.innerHTML = '';
    var search = document.getElementById('searchInput').value.toLowerCase();
    var visible = 0;

    posts.forEach(function (post, i) {
      var matchCat = currentCategory === 'all' || post.category === currentCategory;
      var matchSearch = !search || post.title.toLowerCase().indexOf(search) !== -1 || post.excerpt.toLowerCase().indexOf(search) !== -1;
      if (!matchCat || !matchSearch) return;
      visible++;
      var card = document.createElement('button');
      card.className = 'post-card';
      card.innerHTML =
        '<div class="post-card-category">' + post.category + '</div>' +
        '<div class="post-card-title">' + post.title + '</div>' +
        '<div class="post-card-excerpt">' + post.excerpt + '</div>' +
        '<div class="post-card-meta"><span>' + post.date + '</span><span>' + post.read + '</span></div>';
      card.addEventListener('click', (function (idx) { return function () { openPost(idx); }; })(i));
      grid.appendChild(card);
    });

    document.getElementById('noResults').style.display = visible === 0 ? 'block' : 'none';
    updateFeatured();
  }

  function renderAdminList() {
    var list = document.getElementById('adminPostList');
    list.innerHTML = '';
    if (!posts.length) { list.innerHTML = '<p style="color:var(--muted);font-size:0.85rem;">No posts yet.</p>'; return; }
    posts.forEach(function (post, i) {
      var item = document.createElement('div');
      item.className = 'admin-post-item';
      var info = document.createElement('div');
      info.innerHTML = '<span>' + post.title + '</span><small>' + post.category + ' &middot; ' + post.date + '</small>';
      var del = document.createElement('button');
      del.className = 'delete-btn';
      del.textContent = 'Delete';
      del.addEventListener('click', (function (idx) {
        return function () {
          if (confirm('Delete "' + posts[idx].title + '"?')) {
            posts.splice(idx, 1);
            renderGrid();
            renderAdminList();
          }
        };
      })(i));
      item.appendChild(info);
      item.appendChild(del);
      list.appendChild(item);
    });
  }

  // Nav
  document.getElementById('navLogo').addEventListener('click', function () { showPage('home'); });
  document.getElementById('navWriting').addEventListener('click', function () { showPage('home'); });
  document.getElementById('navAbout').addEventListener('click', function () { showPage('about'); });
  document.getElementById('postBack').addEventListener('click', function () { showPage('home'); });
  document.getElementById('featuredTitle').addEventListener('click', function () { openPost(0); });

  // Search
  document.getElementById('searchInput').addEventListener('input', function () { renderGrid(); });

  // Category filters
  document.getElementById('categoryFilters').addEventListener('click', function (e) {
    var btn = e.target.closest('.filter-btn');
    if (!btn) return;
    currentCategory = btn.getAttribute('data-cat');
    document.querySelectorAll('.filter-btn').forEach(function (b) { b.classList.remove('active'); });
    btn.classList.add('active');
    renderGrid();
  });

  // Admin
  document.getElementById('adminToggle').addEventListener('click', function () {
    document.getElementById('adminPanel').classList.add('open');
    renderAdminList();
  });
  document.getElementById('adminClose').addEventListener('click', function () {
    document.getElementById('adminPanel').classList.remove('open');
  });
  document.getElementById('adminPanel').addEventListener('click', function (e) {
    if (e.target === this) this.classList.remove('open');
  });

  document.getElementById('newPostForm').addEventListener('submit', function (e) {
    e.preventDefault();
    var title = document.getElementById('newTitle').value.trim();
    var category = document.getElementById('newCategory').value;
    var excerpt = document.getElementById('newExcerpt').value.trim();
    var rawBody = document.getElementById('newBody').value.trim();
    var read = document.getElementById('newRead').value.trim() || '5 min read';
    var date = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    var bodyHtml = rawBody.indexOf('<') !== -1 ? rawBody : rawBody.split(/\n\n+/).map(function (p) { return '<p>' + p + '</p>'; }).join('');
    posts.unshift({ id: Date.now(), category: category, title: title, excerpt: excerpt, body: bodyHtml, date: date, read: read });
    e.target.reset();
    document.getElementById('newRead').value = '5 min read';
    renderGrid();
    renderAdminList();
    alert('Post published!');
  });

  // Newsletter
  document.getElementById('newsletterForm').addEventListener('submit', function (e) {
    e.preventDefault();
    alert('Subscribed! Welcome to The Margin.');
    document.getElementById('nlEmail').value = '';
  });

  // Contact
  document.getElementById('contactForm').addEventListener('submit', function (e) {
    e.preventDefault();
    var s = document.getElementById('contactSuccess');
    s.style.display = 'block';
    e.target.reset();
    setTimeout(function () { s.style.display = 'none'; }, 4000);
  });

  renderGrid();
})();
</script>
</body>
</html>
